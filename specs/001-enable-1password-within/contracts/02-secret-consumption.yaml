# Contract Test: Secret Consumption by Workloads
# Purpose: Verify workloads can consume secrets as env vars and mounted files
# Maps to: FR-004 (support environment variables and mounted files)

---
# Setup: Use namespace from previous test
# Assumes test-plain-secret Secret exists
---
# Test: Deployment with environment variable injection
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-env-consumer
  namespace: test-secret-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-env-consumer
  template:
    metadata:
      labels:
        app: test-env-consumer
    spec:
      containers:
        - name: app
          image: busybox:1.36.1
          command: ["sh", "-c", "env | grep TEST_ && sleep 3600"]
          envFrom:
            - secretRef:
                name: test-plain-secret
                optional: false
---
# Assert: Pod running with environment variables
apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 60
---
# Expected: Pod is Running
apiVersion: v1
kind: Pod
metadata:
  namespace: test-secret-sync
  labels:
    app: test-env-consumer
status:
  phase: Running
  containerStatuses:
    - name: app
      ready: true
---
# Test: Deployment with volume mount injection
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-volume-consumer
  namespace: test-secret-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-volume-consumer
  template:
    metadata:
      labels:
        app: test-volume-consumer
    spec:
      containers:
        - name: app
          image: busybox:1.36.1
          command: ["sh", "-c", "ls -la /secrets && sleep 3600"]
          volumeMounts:
            - name: secrets
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: secrets
          secret:
            secretName: test-plain-secret
---
# Assert: Pod running with mounted files
apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 60
---
# Expected: Pod is Running
apiVersion: v1
kind: Pod
metadata:
  namespace: test-secret-sync
  labels:
    app: test-volume-consumer
status:
  phase: Running
  containerStatuses:
    - name: app
      ready: true
