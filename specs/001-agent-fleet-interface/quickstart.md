# Quickstart: Agent Fleet Management MCP Server

**Feature**: 001-agent-fleet-interface
**Target Audience**: Developers implementing the MCP server
**Time to Complete**: ~30 minutes for basic setup

## Prerequisites

- Python 3.12+ installed and available in PATH
- Nx monorepo environment set up (`direnv allow` executed)
- Access to 1Password vault containing Coder API token
- Network access to Coder instance at `https://macbook-pro-van-maarten.tail2c33e2.ts.net`

## Quick Setup

### 1. Navigate to Project Directory

```bash
cd libs/coder-mcp
```

### 2. Install Dependencies

Dependencies are managed via `requirements.txt` with exact version pinning:

```bash
# Create/activate virtual environment (optional but recommended)
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Install dev dependencies for testing
pip install -r requirements-dev.txt
```

Expected dependencies (versions to be pinned):
- `fastmcp==0.5.0` - MCP server framework
- `httpx==0.27.0` - Async HTTP client
- `pydantic==2.5.0` - Data validation
- `python-dotenv==1.0.0` - Environment variable loading
- `vcrpy==5.1.0` - HTTP recording for tests (dev dependency)

### 3. Configure Credentials

The MCP server loads the Coder API token from a `.env` file generated by Nx.

**Generate `.env` file** using the Nx `secrets` target:

```bash
# Generate .env with Coder token from 1Password
nx secrets coder-mcp

# This runs: op read "op://setup-devenv/coder-speckit/credential" > libs/coder-mcp/.env
```

**Prerequisites**:
- 1Password CLI (`op`) installed and authenticated
- Check authentication: `op whoami`
- If not authenticated: `op signin`

**Environment Variables** (in `.env`):
```bash
CODER_SESSION_TOKEN=your-token-here
CODER_URL=https://macbook-pro-van-maarten.tail2c33e2.ts.net
```

**Note**: `.env` is gitignored and must be regenerated per developer/environment.

### 4. Run Tests (TDD Workflow)

Before implementing any code, verify test infrastructure:

```bash
# Run all tests
nx test coder-mcp

# Run specific test categories
pytest tests/unit/          # Unit tests only
pytest tests/integration/   # Integration tests with VCR fixtures
pytest tests/contract/      # Contract tests only

# Run with coverage
pytest --cov=src/coder_mcp --cov-report=html

# Record new VCR cassettes (when writing new tests)
pytest --record-mode=new_episodes

# Re-record all cassettes (after Coder API changes)
pytest --record-mode=rewrite
```

**VCR Cassettes**:
- First test run records real HTTP requests to `tests/fixtures/cassettes/`
- Subsequent runs replay from cassettes (no network calls)
- Delete cassette files to force re-recording
- Cassettes are YAML files with real API responses

**Expected initial state**: All tests should FAIL (red) - this is correct for TDD!

### 5. Start Development Server (Once Implemented)

```bash
# Run MCP server (development mode)
python -m coder_mcp.server

# Or via Nx
nx serve coder-mcp
```

The server will:
1. Retrieve Coder API token from 1Password
2. Initialize FastMCP server with registered tools
3. Listen for MCP tool invocations (stdio or HTTP depending on FastMCP config)

### 6. Test MCP Tools Manually

Use the MCP inspector or a simple client to invoke tools:

```bash
# Example: List all agents
echo '{"method": "tools/call", "params": {"name": "list_agents", "arguments": {}}}' | python -m coder_mcp.server
```

Or use the FastMCP test utilities (refer to FastMCP documentation).

## Development Workflow

### TDD Cycle for Each MCP Tool

1. **Write Test** (Red Phase)
   ```bash
   # Create test file: tests/contract/test_list_agents.py
   # Define expected behavior and assertions
   pytest tests/contract/test_list_agents.py  # Should FAIL
   ```

2. **Implement Tool** (Green Phase)
   ```python
   # Implement in src/coder_mcp/tools/list_agents.py
   # Minimal code to pass test
   ```

3. **Verify Test Passes**
   ```bash
   pytest tests/contract/test_list_agents.py  # Should PASS
   ```

4. **Refactor** (Keep Green)
   - Clean up code, extract helpers
   - Ensure tests still pass after each change

### Running Affected Tests

When making changes, use Nx to run only affected tests:

```bash
# Test only affected projects
nx affected:test

# Lint affected files
nx affected:lint
```

### Code Quality Checks

Before committing:

```bash
# Format code
trunk fmt

# Run linters
trunk check

# Type checking
mypy src/coder_mcp

# Full test suite
nx test coder-mcp
```

## Project Structure

```
libs/coder-mcp/
├── .env                    # Generated by nx secrets (gitignored)
├── src/coder_mcp/
│   ├── server.py           # Start here: FastMCP server setup
│   ├── client.py           # Implement Coder API client
│   ├── config.py           # Implement env var loading & validation
│   ├── models.py           # Define Pydantic models
│   └── tools/              # Implement MCP tools (one per file)
│       ├── list_agents.py
│       ├── get_agent.py
│       └── ...
└── tests/
    ├── fixtures/           # VCR cassettes (recorded HTTP responses)
    │   └── cassettes/      # YAML files with API responses
    ├── contract/           # Test MCP tool contracts
    ├── integration/        # Test full flows with VCR fixtures
    └── unit/               # Test individual modules
```

## Implementation Order (Suggested)

Follow this order to build functionality incrementally:

1. **config.py** - Environment variable loading & validation (unit tests)
2. **client.py** - Coder API HTTP client wrapper (unit tests)
3. **models.py** - Pydantic data models (unit tests with example data)
4. **tools/list_agents.py** - First MCP tool (contract + integration tests with VCR)
   - Run with `nx secrets coder-mcp` first to generate token
   - First test run records VCR cassette from real Coder API
   - Subsequent runs replay from cassette
5. **server.py** - FastMCP server with tool registration (integration tests)
6. Remaining tools in `tools/` (one at a time, TDD for each, record VCR cassettes)

## Common Issues & Solutions

### Issue: Missing .env File

**Error**: `CODER_SESSION_TOKEN environment variable not set`

**Solution**:
```bash
# Generate .env file using Nx secrets target
nx secrets coder-mcp

# Verify .env was created
ls -la libs/coder-mcp/.env
```

### Issue: 1Password Authentication Fails

**Error**: `op: not signed in` when running `nx secrets coder-mcp`

**Solution**:
```bash
op signin
# Follow prompts to authenticate
```

### Issue: Coder API Returns 401 Unauthorized

**Error**: HTTP 401 from Coder API (seen in VCR cassette recordings)

**Solutions**:
1. Regenerate token: `nx secrets coder-mcp`
2. Verify token in 1Password: `op read "op://setup-devenv/coder-speckit/credential"`
3. Check token format: should be valid Coder session token
4. Test API directly:
   ```bash
   source libs/coder-mcp/.env
   curl -H "Coder-Session-Token: $CODER_SESSION_TOKEN" $CODER_URL/api/v2/users/me
   ```

### Issue: VCR Cassette Mismatch

**Error**: `VCR.errors.CannotOverwriteExistingCassetteException`

**Solution**:
```bash
# Delete old cassette and re-record
rm tests/fixtures/cassettes/test_something.yaml
pytest tests/integration/test_something.py --record-mode=new_episodes
```

### Issue: Tests Fail with "Module not found"

**Error**: `ModuleNotFoundError: No module named 'coder_mcp'`

**Solution**:
```bash
# Install package in editable mode
pip install -e .
```

### Issue: httpx SSL Certificate Verification Fails

**Error**: `httpx.ConnectError: [SSL: CERTIFICATE_VERIFY_FAILED]`

**Solutions**:
1. Check Tailscale connection: `tailscale status`
2. Verify Coder URL is reachable: `curl -I https://macbook-pro-van-maarten.tail2c33e2.ts.net`
3. For development only, disable SSL verification (NOT recommended for production):
   ```python
   client = httpx.AsyncClient(verify=False)  # Development only!
   ```

## Next Steps

1. **Read Design Documents**:
   - [research.md](./research.md) - Technology decisions
   - [data-model.md](./data-model.md) - Entity definitions
   - [contracts/](./contracts/) - MCP tool schemas

2. **Implement TDD Workflow**:
   - Start with `test_auth.py` and `auth.py`
   - Progress through implementation order above
   - Keep all tests passing (green) before moving to next module

3. **Integration Testing**:
   - Use pytest-httpx to mock Coder API responses
   - Test error scenarios (network failures, 404s, invalid responses)
   - Validate all status code paths

4. **Documentation**:
   - Add docstrings to all public functions
   - Update this quickstart if you discover better patterns
   - Document any deviations from plan in commit messages

## Resources

- **FastMCP Documentation**: https://github.com/jlowin/fastmcp
- **Coder AI Tasks API Source**: https://github.com/coder/coder/blob/main/coderd/aitasks.go
- **MCP Specification**: https://modelcontextprotocol.io/
- **VCR.py Documentation**: https://vcrpy.readthedocs.io/
- **httpx Documentation**: https://www.python-httpx.org/
- **python-dotenv**: https://github.com/theskumar/python-dotenv

## Support

For questions or issues:
1. Check existing tests for examples
2. Review design documents in `specs/001-agent-fleet-interface/`
3. Consult MCP and FastMCP documentation
4. Open an issue in the monorepo with `[coder-mcp]` prefix
