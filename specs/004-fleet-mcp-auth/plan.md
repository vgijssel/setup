# Implementation Plan: Fleet MCP Authentication

**Branch**: `004-fleet-mcp-auth` | **Date**: 2025-11-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-fleet-mcp-auth/spec.md`

**Note**: This plan has been adapted from the original OAuth 2.1 specification to implement a simpler header-based authentication approach based on user requirements.

## Summary

Add header-based authentication to the existing fleet-mcp FastMCP server. The server will generate a unique access token on first startup and persist it to disk. All MCP tool requests will require this token via the `Authorization: Bearer <token>` header. The token persists across server restarts, providing a simple but effective authentication mechanism for public internet exposure.

**User Clarification**: The user requested to "update the existing FastMCP server and add header based authentication. A unique token needs to be generated when the server starts. When the server restarts the key should remain the same. So the access token is stored somewhere and remains unique."

This is a significant simplification from the original OAuth 2.1 spec, focusing on practical implementation for the current use case.

## Technical Context

**Language/Version**: Python 3.12 (already in use by fleet-mcp)
**Primary Dependencies**:
- fastmcp==2.13.0.2 (existing - provides FastMCP framework)
- pydantic==2.12.3 (existing - for data validation)
- httpx==0.28.1 (existing - for HTTP client)
- python-dotenv==1.2.1 (existing - for env var loading)
- uvicorn==0.34.0 (existing - for ASGI server)
- cryptography==44.0.0 (NEW - for secure token generation)

**Storage**: File-based storage for access token (e.g., `~/.fleet-mcp/auth_token`)
**Testing**: pytest==7.4.3, pytest-asyncio==0.21.1, pytest-cov==4.1.0 (existing)
**Target Platform**: Linux server (Coder workspace), exposed via HTTP
**Project Type**: Single library project (`libs/fleet-mcp`)
**Performance Goals**:
- Token validation <10ms per request
- No impact on existing MCP tool response times
- Token generation on first startup <100ms

**Constraints**:
- Must preserve existing FastMCP server functionality
- Token must persist across server restarts
- Must work with FastMCP's HTTP mode (`stateless_http=True`)
- Must support health check endpoint without authentication (already exists at `/health`)

**Scale/Scope**:
- Single access token (not multi-user)
- ~10 MCP tools to protect
- Token stored in single file on server filesystem

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Minimal Code & Dependency Reuse
✅ **PASS** - Using cryptography library for secure token generation instead of implementing custom crypto. Reusing existing FastMCP middleware patterns.

### II. Deterministic Dependencies
✅ **PASS** - All dependencies pinned to exact versions (cryptography==44.0.0). Existing fleet-mcp already follows this pattern.

### III. Test-Driven Design (TDD)
✅ **PASS** - Will write tests before implementation for:
- Token generation and persistence
- Token validation middleware
- Authentication failure scenarios
- Token file permissions and security

### IV. Nx Monorepo Structure
✅ **PASS** - Modifying existing `libs/fleet-mcp` library. No new projects created. Clear boundary: authentication is a service-layer concern in the existing clean architecture.

### V. Third-Party Dependency Management
✅ **PASS** - New dependency (cryptography) will be added to `libs/fleet-mcp/pyproject.toml` with exact version pinning. Renovatebot will handle updates.

### VI. Semantic Versioning & Independent Releases
✅ **PASS** - This is a minor version bump (0.1.0 → 0.2.0) as it adds backward-compatible authentication without breaking existing MCP tools. Token requirement is opt-in via environment variable initially for safe migration.

### VII. GitOps Deployment
✅ **PASS** - Deployment managed through existing GitOps pipeline. No manual deployment steps required.

### VIII. Tool Availability
✅ **PASS** - No new tools required. Uses existing Python toolchain in `bin/`.

### IX. On-Demand Dependency Provisioning
✅ **PASS** - Dependencies provisioned via existing direnv/Hermit setup.

### X. Modular Library Design
✅ **PASS** - Authentication is a focused module within fleet-mcp. Isolated test suite for auth components. No impact on other libraries.

**Overall Status**: ✅ ALL GATES PASSED - No violations, proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/004-fleet-mcp-auth/
├── plan.md              # This file
├── research.md          # Phase 0: Research findings
├── data-model.md        # Phase 1: Data model
├── quickstart.md        # Phase 1: Quick start guide
├── contracts/           # Phase 1: API contracts (N/A for this feature)
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
libs/fleet-mcp/
├── src/fleet_mcp/
│   ├── __init__.py
│   ├── __main__.py          # MODIFIED: Add auth middleware
│   ├── auth/                # NEW: Authentication module
│   │   ├── __init__.py
│   │   ├── token_manager.py     # Token generation & persistence
│   │   ├── middleware.py        # FastMCP authentication middleware
│   │   └── models.py            # Auth-related Pydantic models
│   ├── clients/
│   ├── models/
│   ├── repositories/
│   ├── services/
│   └── tools/
├── tests/
│   ├── auth/                # NEW: Auth tests
│   │   ├── test_token_manager.py
│   │   ├── test_middleware.py
│   │   └── test_integration.py
│   ├── clients/
│   ├── repositories/
│   ├── services/
│   └── tools/
└── pyproject.toml           # MODIFIED: Add cryptography dependency
```

**Structure Decision**: Using existing `libs/fleet-mcp` single project structure. Adding new `auth/` module alongside existing `clients/`, `models/`, `repositories/`, `services/`, and `tools/` modules. This maintains clean architecture and keeps authentication concerns isolated.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations - all gates passed.

## Post-Design Constitution Re-Check

*Re-evaluation after Phase 1 design completed*

### Design Artifacts Review

**Artifacts Created**:
1. ✅ research.md - Technical decisions documented
2. ✅ data-model.md - Data structures defined (AccessToken, AuthRequest, AuthError)
3. ✅ quickstart.md - User and admin guide complete
4. N/A contracts/ - Not applicable for this feature (no API contracts, using existing MCP protocol)

**Constitution Compliance**:

✅ **I. Minimal Code & Dependency Reuse** - CONFIRMED
- Using Python stdlib `secrets` module (no external dependency needed)
- Research removed cryptography library requirement (simpler solution)
- Reusing Starlette middleware pattern (already in FastMCP stack)

✅ **III. Test-Driven Design (TDD)** - CONFIRMED
- Test structure planned in data-model.md
- Test cases documented for all validation rules
- Unit + integration test layers defined

✅ **X. Modular Library Design** - CONFIRMED
- New `auth/` module isolated from existing code
- Clean interfaces: TokenManager, AuthMiddleware
- No coupling to existing fleet-mcp modules

**Final Status**: ✅ ALL GATES STILL PASSED - Ready for Phase 2 (tasks)

## Implementation Readiness

### Phase 0: Research ✅ COMPLETE
- [x] Token generation approach decided (secrets.token_urlsafe)
- [x] Storage mechanism decided (JSON file with metadata)
- [x] Middleware integration approach decided (Starlette middleware)
- [x] Error handling format decided (OAuth 2.1-style JSON)
- [x] Configuration approach decided (environment variables)

### Phase 1: Design ✅ COMPLETE
- [x] Data model defined (AccessToken, AuthRequest, AuthError)
- [x] File storage format specified (JSON with value + created_at)
- [x] State transitions documented (token lifecycle, request flow)
- [x] Validation rules specified (token format, file permissions, headers)
- [x] User documentation complete (quickstart.md)

### Phase 2: Tasks ⏳ NEXT
- [ ] Run `/speckit.tasks` to generate task breakdown
- [ ] Execute TDD workflow (tests first, then implementation)

## Summary

Implementation plan complete and ready for task generation. The simplified header-based authentication approach provides adequate security while maintaining minimal complexity. All constitutional gates passed. No external dependencies required (using Python stdlib). Clean architecture preserved with isolated `auth/` module. User and admin documentation complete.

**Key Simplifications from Original Spec**:
- ❌ OAuth 2.1 authorization server (not needed)
- ❌ RFC 8707 resource indicators (not needed)
- ❌ JWKS public key fetching (not needed)
- ❌ Token refresh flow (single persistent token)
- ✅ Simple header-based Bearer token
- ✅ File-based persistence
- ✅ Starlette middleware integration
- ✅ Backward compatible opt-in via environment variable

**Next Command**: `/speckit.tasks` to generate implementation task breakdown.
