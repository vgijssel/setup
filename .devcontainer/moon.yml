language: javascript
layer: library
dependsOn:
  - devenv
tasks:
  build:
    script: |
      devcontainer \
        build \
        --workspace-folder $SETUP_DIR \
        --platform linux/amd64,linux/arm64 \
        --push \
        --image-name ghcr.io/vgijssel/setup/devcontainer-dev:$MOON_TASK_HASH \
        --cache-from type=registry,ref=ghcr.io/vgijssel/setup/devcontainer-dev:cache \
        --cache-to type=registry,ref=ghcr.io/vgijssel/setup/devcontainer-dev:cache,mode=max &&
         echo "ghcr.io/vgijssel/setup/devcontainer-dev:$MOON_TASK_HASH" > $SETUP_DIR/.devcontainer/.docker-version
    deps:
      - devcontainers-cli:build
      - docker:buildx_run
      - vendir:build
    inputs:
      - file: Dockerfile
      - file: devcontainer.json
      - file: /.envrc
      - glob: /bin/**/*
        cache: true
      - glob: /third_party/hermit/**/*
        cache: true
      - glob: /third_party/vendir/shell/**/*
        cache: true
      - glob: /libs/devenv/**/*
        cache: true
      - file: /.chezmoiroot
    outputs:
      - .docker-version
    options:
      cache: true
  release:
    command: ./release.sh
    deps:
      - ~:build
    local: true
  test:
    command: bats tests/test.bats
    inputs:
      - file: .docker-version
      - file: tests/test.bats
      - file: tests/goss.yaml
    deps:
      - ~:build
    options:
      cache: true
      # This test can be flacky due to external network calls, so we allow retries
      retryCount: 3

  envbuilder-test:
    command: bats tests/envbuilder-test.bats
    deps:
      - docker:registry_run
    inputs:
      - file: Dockerfile
      - file: devcontainer.json
      - file: tests/envbuilder-test.bats
      - file: /.envrc
      - glob: /bin/**/*
      - glob: /third_party/hermit/**/*
      - glob: /third_party/vendir/shell/**/*
      - glob: /libs/devenv/**/*
      - file: /.chezmoiroot
    options:
      cache: true
      # This test can be flacky due to external network calls, so we allow retries
      retryCount: 3
