language: javascript
layer: library
dependsOn:
  - devenv
  - devcontainer-install-extensions
tasks:
  build:
    command: ./build.sh --tag $MOON_TASK_HASH
    deps:
      - devcontainers-cli:build
      - vendir:build
    inputs:
      - file: Dockerfile
      - file: build.sh
      - file: /.envrc
      - glob: /bin/**/*
        cache: true
      - glob: /third_party/hermit/**/*
        cache: true
      - glob: /third_party/vendir/shell/**/*
        cache: true
      - glob: /libs/devenv/**/*
        cache: true
      - file: /.chezmoiroot
    outputs:
      - .docker-version
    options:
      cache: true
  release:
    command: ./release.sh
    deps:
      - ~:build
    local: true
  test:
    command: bats tests/test.bats
    inputs:
      - file: .docker-version
      - file: tests/test.bats
      - file: tests/goss.yaml
    deps:
      - ~:build
    options:
      cache: true
      # This test can be flacky due to external network calls, so we allow retries
      retryCount: 3

  envbuilder-test:
    command: ./envbuilder-test.sh
    inputs:
      - file: Dockerfile
      - file: devcontainer.json
      - file: envbuilder-test.sh
      - file: /.envrc
      - glob: /bin/**/*
      - glob: /third_party/hermit/**/*
      - glob: /third_party/vendir/shell/**/*
      - glob: /libs/devenv/**/*
      - file: /.chezmoiroot
