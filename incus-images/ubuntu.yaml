image:
  name: pikvm-rpi4
  distribution: pikvm-rpi4
  release: latest
  description: |-
    PiKVM {{ image.release }}
  architecture: arm64

# TODO: do we need this?
source:
  downloader: rootfs-http
  url: file://noop

targets:
  lxc:
    create_message: |-
      You just created an {{ image.description }} container.

      To enable SSH, run: apt install openssh-server
      No default root or user password are set by LXC.
    config: []

files:
  - path: /etc/hostname
    generator: hostname

  # We're overriding the fstab file as we don't use those partitions anymore in LXC
  - path: /etc/fstab
    uid: 0
    gid: 0
    mode: 0600
    generator: dump
    content: |-
      /dev/cdrom	/media/cdrom	iso9660	noauto,ro 0 0
      /dev/usbdisk	/media/usb	vfat	noauto,ro 0 0

  # Disable the msd service by default as we're missing the msd partition
  - path: /etc/kvmd/override.d/disable-msd
    uid: 0
    gid: 0
    mode: 0600
    generator: dump
    content: |-
      kvmd:
        msd:
          type: disabled

packages:
  manager: pacman
  update: false
  cleanup: false
  sets:
    - packages:
        - cloud-init
      action: install

actions:
  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux

      # Don't need persistant storage service: https://docs.pikvm.org/pst/
      systemctl mask kvmd-pst

      # Don't need kvmd-fan service
      systemctl mask kvmd-fan

      # The bootconfig does not work, we need to do this manually
      systemctl mask kvmd-bootconfig.service 

      # Enable the OLED service
      systemctl enable kvmd-oled

      # Generate a new certificate
      # kmd-gencert --do-the-thing

      # Generate a new certificate for vnc
      # kmd-gencert --do-the-thing --vnc
