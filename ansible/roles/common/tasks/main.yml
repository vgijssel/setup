- name: Ensure the Ansible tmp directory exists for the "{{ ansible_user }}" user to prevent permission issues
  ansible.builtin.file:
    path: "{{ ansible_remote_tmp }}"
    state: directory
    group: "{{ ansible_user }}"
    owner: "{{ ansible_user }}"

- name: Update apt package index
  ansible.builtin.apt:
    update_cache: yes
    # Cache is valid for 24 hours
    cache_valid_time: 86400
  become: true
  when: ansible_distribution != 'Archlinux'

- name: Upgrade all packages to the latest version
  ansible.builtin.apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  become: true
  when: ansible_distribution != 'Archlinux'

- name: Check if a reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required
  when: ansible_distribution != 'Archlinux'

- name: Reboot the server if needed
  ansible.builtin.reboot:
  become: true
  when: ansible_distribution != 'Archlinux' and reboot_required.stat.exists

- name: Install unattended upgrades
  ansible.builtin.package:
    name: unattended-upgrades
    state: present
  become: true
  when: ansible_distribution != 'Archlinux'

- name: Configure unattended security upgrades
  ansible.builtin.copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart unattended-upgrades
  when: ansible_distribution != 'Archlinux'

- name: Add locale to file
  ansible.builtin.lineinfile:
    path: /etc/locale.gen
    line: en_GB.UTF-8 UTF-8
  become: true
  register: add_locale_result

- name: Run locale-gen
  ansible.builtin.command:
    cmd: locale-gen
  become: true
  when: add_locale_result.changed

- name: Copy locale settings
  ansible.builtin.copy:
    src: locale
    dest: "{{ item }}"
    owner: root
    group: root
    mode: "0644"
  become: true
  loop:
    - /etc/default/locale
    - /etc/locale.conf

- name: Set timezone to Europe/Amsterdam
  become: true
  community.general.timezone:
    name: Europe/Amsterdam

- name: Install whois for mkpasswd
  ansible.builtin.package:
    name: whois
    state: present
  become: true

- name: Ensure group "sudo" exists
  ansible.builtin.group:
    name: sudo
    state: present
  become: true

- name: Set root password
  user:
    name: root
    password: "{{ root_user_password_encrypted }}"
  become: true

- name: Remove authorized keys for root
  ansible.builtin.file:
    path: /root/.ssh/authorized_keys
    state: absent
  become: true

- name: Create maarten user
  user:
    name: maarten
    password: "{{ maarten_user_password_encrypted }}"
    state: present
    shell: /bin/bash
    groups: [sudo]
    create_home: true
  become: true

- name: Set authorized key for maarten
  ansible.posix.authorized_key:
    user: maarten
    state: present
    key: "{{ maarten_user_public_key }}"
    exclusive: true
  become: true

- name: Ensure maarten needs to enter password for sudo
  community.general.sudoers:
    name: 99_maarten-sudo
    user: maarten
    nopassword: false
    commands: ALL
    validation: required
  become: true

- name: Set authorized key for maarten
  ansible.posix.authorized_key:
    user: maarten
    state: present
    key: "{{ maarten_user_public_key }}"
    exclusive: true
  become: true

- name: Update deploy user
  user:
    name: deploy
    password: "{{ deploy_user_password_encrypted }}"
    state: present
    create_home: true
    shell: /bin/bash
    groups: [sudo]
  become: true

- name: Ensure deploy needs to enter password for sudo
  community.general.sudoers:
    name: 99_deploy-sudo
    user: deploy
    nopassword: false
    commands: ALL
    validation: required
  become: true

- name: Remove authorized keys for deploy
  ansible.builtin.file:
    path: /home/deploy/.ssh/authorized_keys
    state: absent
  become: true

- name: Remove ubuntu user
  ansible.builtin.user:
    name: ubuntu
    state: absent
    remove: yes
  become: true

- name: Set sudo timeout to 5 minutes
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: ^Defaults passwd_timeout=
    line: Defaults passwd_timeout=5
    validate: /usr/sbin/visudo -cf %s
  become: true

- name: Authenticate sudo per tty session
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    line: Defaults tty_tickets
    validate: /usr/sbin/visudo -cf %s
  become: true

- name: Set sshd configuration
  ansible.builtin.copy:
    src: 00-sshd_config.conf
    dest: /etc/ssh/sshd_config.d/00-sshd_config.conf
    owner: root
    group: root
    mode: "0755"
  become: true
  notify: restart ssh

- name: Install net-tools to inspect routing table
  ansible.builtin.package:
    name: net-tools
    state: present
  become: true

- name: Copy Netplan template
  ansible.builtin.template:
    src: 90-common-network.yaml.j2
    dest: /etc/netplan/90-common-network.yaml
    group: root
    owner: root
    mode: "0600"
  become: true
  notify: apply netplan
  when: ansible_distribution != 'Archlinux'

- name: Install vim
  ansible.builtin.package:
    name: vim
    state: present
  become: true

- name: Set vim as the default editor for all users
  ansible.builtin.copy:
    src: default_editor.sh
    dest: /etc/profile.d/default_editor.sh
    owner: root
    group: root
    mode: "0644"
  become: true
