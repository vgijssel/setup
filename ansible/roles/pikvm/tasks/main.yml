- name: Remount read-write to prepare for changes
  ansible.builtin.command: rw
  changed_when: false
  when: not ansible_check_mode

- name: Generate PiKVM config
  ansible.builtin.template:
    src: meta.yml.j2
    dest: /etc/kvmd/meta.yaml
    group: root
    owner: root
    mode: "0644"
  vars:
    pikvm_hostname: "{{ ansible_hostname }}"

# From https://docs.pikvm.org/faq "I want to get read-write filesystem all of the time"
- name: Update kernel parameters to bootable
  ansible.builtin.copy:
    src: cmdline.txt
    dest: /boot/cmdline.txt
    owner: root
    group: root
    mode: "0755"

- name: Make boot partition writable
  ansible.posix.mount:
    path: /boot
    src: LABEL=PIBOOT
    fstype: vfat
    opts: rw,errors=remount-ro
    dump: 0
    passno: 2
    state: mounted

- name: Remove tmpfs mount for {{ item.path }}
  ansible.posix.mount:
    path: "{{ item.path }}"
    fstype: tmpfs
    opts: "{{ item.opts}}"
    dump: 0
    passno: 0
    state: absent
  with_items:
    - { path: /var/lib/systemd, opts: mode=0755 }
    - { path: /var/lib/private, opts: mode=0700 }
    - { path: /var/lib/dhclient, opts: mode=0755 }
    - { path: /var/lib/dhcpcd, opts: mode=0750 }
    - { path: /var/log, opts: nodev, nosuid }
