- name: Remount read-write to prepare for changes
  ansible.builtin.command: rw
  changed_when: false
  when: not ansible_check_mode

- name: Generate PiKVM config
  ansible.builtin.template:
    src: meta.yml.j2
    dest: /etc/kvmd/meta.yaml
    group: root
    owner: root
    mode: "0644"
  vars:
    pikvm_hostname: "{{ ansible_hostname }}"

# From https://docs.pikvm.org/faq "I want to get read-write filesystem all of the time"
#
# fstab table from fresh pikvm installation:
#
# LABEL=PIBOOT  /boot               vfat   ro,errors=remount-ro    0 2
# tmpfs         /var/lib/systemd    tmpfs  mode=0755               0 0
# tmpfs         /var/lib/private    tmpfs  mode=0700               0 0
# tmpfs         /var/lib/dhclient   tmpfs  mode=0755               0 0
# tmpfs         /var/lib/dhcpcd     tmpfs  mode=0750               0 0
# tmpfs         /var/log            tmpfs  nodev,nosuid            0 0
# tmpfs         /var/tmp            tmpfs  nodev,nosuid,mode=1777  0 0
# tmpfs         /tmp                tmpfs  nodev,nosuid,mode=1777  0 0
# LABEL=PIPST  /var/lib/kvmd/pst  ext4  nodev,nosuid,noexec,ro,errors=remount-ro,X-kvmd.pst-user=kvmd-pst  0 2
# LABEL=PIMSD  /var/lib/kvmd/msd  ext4  nodev,nosuid,noexec,ro,errors=remount-ro,X-kvmd.otgmsd-user=kvmd  0 2
#
- name: Update kernel parameters to bootable
  ansible.builtin.copy:
    src: cmdline.txt
    dest: /boot/cmdline.txt
    owner: root
    group: root
    mode: "0755"
  notify:
    - reboot

- name: Make boot partition writable
  ansible.posix.mount:
    path: /boot
    src: LABEL=PIBOOT
    fstype: vfat
    opts: rw,errors=remount-ro
    dump: 0
    passno: 2
    state: mounted
  notify:
    - reboot

- name: Remove tmpfs mount for {{ item.path }}
  ansible.posix.mount:
    path: "{{ item.path }}"
    src: tmpfs
    fstype: tmpfs
    opts: "{{ item.opts}}"
    dump: 0
    passno: 0
    state: absent
  with_items:
    - { path: /var/lib/systemd, opts: mode=0755 }
    - { path: /var/lib/private, opts: mode=0700 }
    - { path: /var/lib/dhclient, opts: mode=0755 }
    - { path: /var/lib/dhcpcd, opts: mode=0750 }
    - { path: /var/log, opts: nodev, nosuid }
  notify:
    - reboot
