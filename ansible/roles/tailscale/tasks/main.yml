- name: Use the custom lookup
  debug:
    msg: "{{ tailscale_provisioner }} {{ tailscale_provisioner }}"

# From https://tailscale.com/download/linux
- name: Add Tailscale package signing key
  ansible.builtin.apt_key:
    url: https://pkgs.tailscale.com/stable/{{ ansible_lsb["id"] | lower }}/{{ ansible_lsb["codename"] | lower }}.noarmor.gpg
    keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
  register: tailscale_key_result
  become: true

- name: Add specified repository into sources list using specified filename
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/{{ ansible_lsb["id"] | lower }} {{ ansible_lsb["codename"] | lower }} main
    state: present
    filename: tailscale
  register: tailscale_repository_result
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: true
  when: tailscale_key_result.changed or tailscale_repository_result.changed

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
  become: true
# TODO: needs auth key from 1Password
# - name: Register Tailscale device
#   ansible.builtin.command: tailscale login --authkey <authkey>
#   become: true
