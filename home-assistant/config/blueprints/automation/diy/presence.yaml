blueprint:
  name: "Room - Presence: Manage"
  description: Toggle if there is a human within a room
  domain: automation
  source_url: https://github.com/mvgijssel/setup
  input:
    presence_entity:
      name: Presence Entity
      selector:
        entity:
          domain: input_boolean

    motion_entities:
      name: Motion Sensor
      default: []
      selector:
        entity:
          domain: binary_sensor
          # TODO: can we have multiple types of device_class?
          # device_class: motion
          multiple: true

    shelly_entity:
      name: Shelly Input
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: power
          multiple: true

    # TODO: how to specify optional inputs?
    door_entity:
      name: Door Sensor
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true

    presence_timeout:
      name: Presence Timeout
      description: Time to wait after no presence events happened
      default: 60
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds

# If motion is detected within the delay,
# we restart the script.
mode: restart
# max_exceeded: silent

variables:
  motion_entity_ids: !input motion_entities

trigger:
  - platform: state
    entity_id: !input motion_entities
    from: "off"
    to: "on"

  - platform: state
    entity_id: !input shelly_entity

  - platform: state
    entity_id: !input door_entity

action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: !input presence_entity

  # Wait until all motion sensors are reporting no motion
  - wait_template: >
      {% set motion_entities = expand(motion_entity_ids)  %}
      {% set has_motion = motion_entities | selectattr("state", "equalto", "on") | list | length > 0 %}
      {% set has_no_motion = not has_motion %}
      {{ has_no_motion }}

  - delay:
      hours: 0
      minutes: 0
      seconds: !input presence_timeout
      milliseconds: 0

  - service: input_boolean.turn_off
    data: {}
    target:
      entity_id: input_boolean.office_presence
