- id: '1655749208565'
  alias: 'Supply Closet - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.supply_closet_presence
      presence_indicator_entity_ids:
      - binary_sensor.supply_closet_door_contact
      presence_hint_entity_ids:
      - binary_sensor.supply_closet_shelly_input
      presence_timeout: 0
- id: '1655751397719'
  alias: 'Toilet - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.toilet_presence
      presence_indicator_entity_ids:
      - binary_sensor.toilet_motion_occupancy
      presence_hint_entity_ids:
      - binary_sensor.toilet_shelly_input_1
      - binary_sensor.toilet_shelly_input_2
      - binary_sensor.toilet_door_contact
      presence_timeout: 180
- id: '1655751783256'
  alias: 'Driveway - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.driveway_presence
      presence_indicator_entity_ids:
      - binary_sensor.driveway_doorbell_motion
      - binary_sensor.hallway_door_contact
      presence_hint_entity_ids:
      - binary_sensor.driveway_shelly_input
      presence_timeout: 120
- id: '1655752570246'
  alias: 'Hallway - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.hallway_presence
      presence_hint_entity_ids:
      - binary_sensor.hallway_shelly_input
      - binary_sensor.toilet_door_contact
      - binary_sensor.living_room_door_contact
      - binary_sensor.driveway_shelly_input
      - binary_sensor.landing_motion_occupancy
      - binary_sensor.living_room_motion_occupancy
      - binary_sensor.toilet_motion_occupancy
      presence_timeout: 120
      presence_indicator_entity_ids:
      - binary_sensor.hallway_motion_occupancy
      - binary_sensor.hallway_door_contact
- id: '1655752934365'
  alias: 'Laundry Room - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.laundry_room_presence
      presence_indicator_entity_ids:
      - binary_sensor.laundry_room_motion_occupancy
      presence_hint_entity_ids:
      - binary_sensor.laundry_room_shelly_input
- id: '1655753137217'
  alias: 'Office - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.office_presence
      presence_indicator_entity_ids:
      - binary_sensor.office_human_presence
      - binary_sensor.office_motion_occupancy
      presence_hint_entity_ids:
      - binary_sensor.office_door_contact
      - binary_sensor.office_shelly_input
- id: '1655755184933'
  alias: 'Driveway - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.driveway_presence
      light_and_switch_entity_ids:
      - switch.driveway_shelly
      start_time: 00:00:00
      end_time: '23:59:59'
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 1000
- id: '1655798724103'
  alias: 'Hallway - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.hallway_presence
      illuminance_entity_id: sensor.hallway_motion_illuminance_lux
      light_and_switch_entity_ids:
      - light.hallway_lights
      start_time: 00:00:00
      end_time: '23:59:59'
      illuminance_threshold: 1000
- id: '1655799885346'
  alias: 'Laundry Room - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.laundry_room_presence
      illuminance_entity_id: sensor.laundry_room_motion_illuminance_lux
      illuminance_threshold: 100
      light_and_switch_entity_ids:
      - switch.laundry_room_shelly
      start_time: 07:00:00
      end_time: '21:00:00'
- id: '1655800011564'
  alias: 'Office - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.office_presence
      illuminance_entity_id: sensor.office_illuminance_illuminance_lux
      light_and_switch_entity_ids:
      - switch.office_shelly
      start_time: 07:00:00
      end_time: '23:00:00'
      illuminance_threshold: 40
- id: '1655800068148'
  alias: 'Supply Closet - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.supply_closet_presence
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 200000
      light_and_switch_entity_ids:
      - switch.supply_closet_shelly
      start_time: 00:00:00
      end_time: '23:59:59'
- id: '1655800128048'
  alias: 'Toilet - Light: Manage'
  description: ''
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: sensor.toilet_presence
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 200000
      light_and_switch_entity_ids:
      - light.toilet_lights
      start_time: 00:00:00
      end_time: '23:59:59'
- id: '1655926470261'
  alias: 'Kitchen - Presence: Manage'
  description: ''
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: sensor.kitchen_presence
      presence_indicator_entity_ids:
      - binary_sensor.kitchen_human_presence
- id: '1657026314050'
  alias: 'Bedroom - Sleeping: Manage'
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.bedroom_1_button_action
    to: 'on'
    id: button_1
  - platform: state
    entity_id:
    - sensor.bedroom_2_button_action
    id: button_2
    to: 'on'
  - platform: time
    at: '22:00:00'
    id: evening_time
  - platform: time
    at: 07:00:00
    id: morning_time
  condition: []
  action:
  - if:
    - condition: trigger
      id: button_1
    then:
    - wait_for_trigger:
      - platform: state
        entity_id:
        - sensor.bedroom_1_button_action
        to: 'on'
      timeout: '1'
    - if:
      - condition: template
        value_template: '{{ wait.remaining > 0 }} '
      then:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
      else:
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
  - if:
    - condition: trigger
      id: button_2
    then:
    - wait_for_trigger:
      - platform: state
        entity_id:
        - sensor.bedroom_2_button_action
        to: 'on'
      timeout: '1'
    - if:
      - condition: template
        value_template: '{{ wait.remaining > 0 }} '
      then:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
      else:
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
  - if:
    - condition: or
      conditions:
      - condition: trigger
        id: evening_time
      - condition: trigger
        id: morning_time
    then:
    - if:
      - condition: time
        after: '22:00:00'
        before: 07:00:00
      then:
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
      else:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id: input_boolean.bedroom_is_sleeping
  mode: single
- id: '1658226673278'
  alias: 'Adaptive lighting: toggle ''sleep mode'''
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.bedroom_is_sleeping
  - platform: homeassistant
    event: start
  variables:
    sleep_mode: '{{ states(''input_boolean.bedroom_is_sleeping'') }}'
  condition: []
  action:
    service: switch.turn_{{ sleep_mode }}
    entity_id:
    - switch.adaptive_lighting_sleep_mode_baby_room
    - switch.adaptive_lighting_sleep_mode_landing
    - switch.adaptive_lighting_sleep_mode_hallway
  mode: single
- id: '1664274065748'
  alias: Driveway - Doorbell Play Chime
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.driveway_doorbell_doorbell
    from: 'off'
    to: 'on'
  condition: []
  action:
  - parallel:
    - service: sonos.snapshot
      data:
        entity_id: media_player.woonkamer
    - service: sonos.snapshot
      data:
        entity_id: media_player.sonos_move
  - service: media_player.volume_set
    data:
      volume_level: 0.65
    target:
      entity_id:
      - media_player.woonkamer
      - media_player.sonos_move
  - service: media_player.play_media
    data:
      media_content_type: music
      media_content_id: http://hypervisor:8123/local/sounds_sounds_ring_button_Chime.mp3
    target:
      entity_id:
      - media_player.woonkamer
      - media_player.sonos_move
  - delay:
      hours: 0
      minutes: 0
      seconds: 4
      milliseconds: 0
  - parallel:
    - service: sonos.restore
      data:
        entity_id: media_player.woonkamer
    - service: sonos.restore
      data:
        entity_id: media_player.sonos_move
  mode: single
- id: '1674554618790'
  alias: Apple Watch Location 1
  trace:
    stored_traces: 300
  description: ''
  trigger:
  - platform: mqtt
    topic: home/location/bluetooth-00:00:00:00:00:00
    id: mqtt
  - platform: time_pattern
    seconds: /10
    id: time
  condition: []
  action:
  - if:
    - condition: trigger
      id: time
    then:
    - if:
      - condition: template
        value_template: '{% set the_past = state_attr(''sensor.apple_watch_1_location'',
          ''last_updated'') %}

          {% set the_present = now() %}

          {% set seconds_passed = as_timestamp(the_present)-as_timestamp(the_past)
          %}


          {{ seconds_passed > 120 }}'
      then:
      - service: variable.update_sensor
        target:
          entity_id: sensor.apple_watch_1_location
        data:
          value: away
          attributes:
            next_location: away
            next_location_iteration: 0
            next_location_duration: 0
            icon: mdi:home-outline
            last_updated: '{{ now() }}'
    - stop: Done checking away status
    alias: Check for away status
  - if:
    - condition: template
      value_template: '{{ trigger.payload_json.location == states(''sensor.apple_watch_1_location'')
        }}'
    then:
    - service: variable.update_sensor
      target:
        entity_id: sensor.apple_watch_1_location
      data:
        attributes:
          next_location: '{{ states(''sensor.apple_watch_1_location'') }}'
          next_location_iteration: 0
          icon: mdi:home
          last_updated: '{{ now() }}'
    - stop: Nothing changed
    alias: same location
  - if:
    - condition: template
      value_template: '{{ trigger.payload_json.guesses[0].probability < 0.5 }}'
    then:
    - service: variable.update_sensor
      target:
        entity_id: sensor.apple_watch_1_location
      data:
        attributes:
          next_location: '{{ states(''sensor.apple_watch_1_location'') }}'
          next_location_iteration: 0
          icon: mdi:home
          last_updated: '{{ now() }}'
    - stop: Probability too low
    alias: low probability
  - if:
    - condition: template
      value_template: '{{ trigger.payload_json.location != state_attr(''sensor.apple_watch_1_location'',
        ''next_location'') }}'
    then:
    - service: variable.update_sensor
      target:
        entity_id: sensor.apple_watch_1_location
      data:
        attributes:
          next_location: '{{ trigger.payload_json.location }}'
          next_location_iteration: 0
          icon: mdi:home
          last_updated: '{{ now() }}'
    alias: Update next location
  - service: variable.update_sensor
    target:
      entity_id: sensor.apple_watch_1_location
    data:
      attributes:
        next_location_iteration: '{{ (state_attr(''sensor.apple_watch_1_location'',
          ''next_location_iteration'') | int(default=0)) + 1 }}'
    alias: Next location iteration increment
  - if:
    - condition: template
      value_template: '{{ (state_attr(''sensor.apple_watch_1_location'', ''next_location_iteration'')
        | int(default=0)) > 1 }}'
    then:
    - service: variable.update_sensor
      target:
        entity_id: sensor.apple_watch_1_location
      data:
        value: '{{ state_attr(''sensor.apple_watch_1_location'', ''next_location'')
          }}'
        attributes:
          next_location: '{{ state_attr(''sensor.apple_watch_1_location'', ''next_location'')
            }}'
          next_location_iteration: 0
          icon: mdi:home
          last_updated: '{{ now() }}'
    alias: Change location
  mode: single
- id: '1687445709673'
  alias: Living Room Dining Table - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_dining_table_human_presence
      light_and_switch_entity_ids:
      - light.living_room_dining_table_light
      illuminance_entity_id: sensor.living_room_illuminance
      away_timer_entity_id: timer.living_room_dining_table_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.living_room_dining_table_manual_timer
      manual_timer_duration:
        hours: 3
        minutes: 0
        seconds: 0
      illuminance_threshold: 150
- id: '1687446669605'
  alias: Living Room Kitchen - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_kitchen_human_presence
      light_and_switch_entity_ids:
      - light.kitchen_lights
      illuminance_entity_id: sensor.living_room_illuminance
      away_timer_entity_id: timer.living_room_kitchen_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.living_room_kitchen_manual_timer
      manual_timer_duration:
        hours: 3
        minutes: 0
        seconds: 0
      illuminance_threshold: 150
- id: '1687446932202'
  alias: Living Room Reading - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_reading_human_presence
      light_and_switch_entity_ids:
      - light.living_room_monkey_light
      illuminance_entity_id: sensor.living_room_illuminance
      away_timer_entity_id: timer.living_room_reading_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.living_room_reading_manual_timer
      manual_timer_duration:
        hours: 3
        minutes: 0
        seconds: 0
      illuminance_threshold: 150
- id: '1687447110495'
  alias: Living Room Sofa - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_sofa_human_presence
      light_and_switch_entity_ids:
      - light.living_room_corner_light
      - light.living_room_tv_light
      illuminance_entity_id: sensor.living_room_illuminance
      away_timer_entity_id: timer.living_room_sofa_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.living_room_sofa_manual_timer
      manual_timer_duration:
        hours: 3
        minutes: 0
        seconds: 0
      illuminance_threshold: 150
- id: '1687452619492'
  alias: Bathroom Shower - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.bathroom_shower_human_presence
      illuminance_entity_id: sensor.bathroom_illuminance
      away_timer_entity_id: timer.bathroom_shower_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.bathroom_shower_manual_timer
      manual_timer_duration:
        hours: 1
        minutes: 0
        seconds: 0
      light_and_switch_entity_ids:
      - light.bathroom_1_light
      - light.bathroom_2_light
      - light.bathroom_3_light
      illuminance_threshold: 500
- id: '1687452837238'
  alias: Bathroom Washing - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      light_and_switch_entity_ids:
      - light.bathroom_4_light
      - light.bathroom_5_light
      - light.bathroom_6_light
      illuminance_entity_id: sensor.bathroom_illuminance
      away_timer_entity_id: timer.bathroom_washing_away_timer
      away_timer_duration:
        hours: 0
        minutes: 3
        seconds: 0
      manual_timer_entity_id: timer.bathroom_washing_manual_timer
      manual_timer_duration:
        hours: 1
        minutes: 0
        seconds: 0
      illuminance_threshold: 500
      presence_entity_id: binary_sensor.bathroom_washing_human_presence
- id: '1687512815133'
  alias: Bedroom - Lights
  description: ''
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.bedroom_human_presence
      light_and_switch_entity_ids:
      - switch.bedroom_shelly
      illuminance_entity_id: sensor.bedroom_illuminance
      away_timer_entity_id: timer.bedroom_away_timer
      away_timer_duration:
        hours: 0
        minutes: 1
        seconds: 0
      manual_timer_entity_id: timer.bedroom_manual_timer
      manual_timer_duration:
        hours: 9
        minutes: 0
        seconds: 0
- id: '1688322983719'
  alias: Living Room - Door Occupancy
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.living_room_door_contact
    from:
    to:
  - platform: state
    entity_id:
    - binary_sensor.living_room_motion_occupancy
    from:
    to:
  - platform: homeassistant
    event: start
  condition: []
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: "{% set door_id = 'binary_sensor.living_room_door_contact'
          %}\n{% set timeout = 10 %}\n\n{% set door_activity_timeout = now() - timedelta(seconds
          = timeout) %}\n{% set door_last_updated = states[door_id].last_updated %}
          \n{% set door_recently_updated = door_last_updated >= door_activity_timeout
          %}\n\n{{ door_recently_updated }}"
        alias: Door contact recently had activity
      sequence:
      - service: variable.update_sensor
        data:
          replace_attributes: false
          attributes:
            icon: mdi:motion-sensor
          value: 'on'
        target:
          entity_id: sensor.living_room_door_occupancy
        alias: Set door activity
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - service: variable.update_sensor
        data:
          replace_attributes: false
          value: 'off'
          attributes:
            icon: mdi:motion-sensor-off
        target:
          entity_id: sensor.living_room_door_occupancy
        alias: Unset door activity
    - conditions:
      - condition: state
        entity_id: binary_sensor.living_room_door_contact
        state: 'on'
      - condition: state
        entity_id: binary_sensor.living_room_motion_occupancy
        state: 'on'
      sequence:
      - service: variable.update_sensor
        data:
          replace_attributes: false
          value: 'on'
          attributes:
            icon: mdi:motion-sensor
        target:
          entity_id: sensor.living_room_door_occupancy
        alias: Set door activity
    default:
    - service: variable.update_sensor
      data:
        replace_attributes: false
        value: 'off'
        attributes:
          icon: mdi:motion-sensor-off
      target:
        entity_id: sensor.living_room_door_occupancy
      alias: Unset door activity
  mode: single
- id: '1688367427268'
  alias: Hallway - Presence
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.living_room_door_occupancy
    id: doors
    from: 'off'
    to: 'on'
  - platform: state
    entity_id:
    - input_select.hallway_presence
    from:
    to:
    id: state
  - platform: state
    entity_id:
    - timer.hallway_transition_timer
    from:
    to:
    id: timer
  - platform: state
    entity_id:
    - binary_sensor.hallway_human
    from:
    to:
    id: human
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.hallway_presence
        state: absent
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id: doors
          sequence:
          - service: input_select.select_option
            data:
              option: entering
            target:
              entity_id: input_select.hallway_presence
        - conditions:
          - condition: trigger
            id: state
          sequence:
          - service: timer.cancel
            data: {}
            target:
              entity_id: timer.hallway_transition_timer
    - conditions:
      - condition: state
        entity_id: input_select.hallway_presence
        state: entering
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id: state
          sequence:
          - service: timer.start
            data:
              duration: 00:00:10
            target:
              entity_id: timer.hallway_transition_timer
        - conditions:
          - condition: trigger
            id: timer
          - condition: state
            entity_id: timer.hallway_transition_timer
            state: idle
          sequence:
          - service: input_select.select_option
            data:
              option: absent
            target:
              entity_id: input_select.hallway_presence
          - stop: Back to absent.
        - conditions:
          - condition: trigger
            id: doors
          sequence:
          - service: timer.change
            data:
              duration: 00:00:10
            target:
              entity_id: timer.hallway_transition_timer
      - if:
        - condition: state
          entity_id: binary_sensor.hallway_human
          state: 'on'
        then:
        - service: input_select.select_option
          data:
            option: present
          target:
            entity_id: input_select.hallway_presence
    - conditions:
      - condition: state
        entity_id: input_select.hallway_presence
        state: present
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id: state
          sequence:
          - service: timer.cancel
            data: {}
            target:
              entity_id: timer.hallway_transition_timer
        - conditions:
          - condition: trigger
            id: doors
          sequence:
          - service: input_select.select_option
            data:
              option: leaving
            target:
              entity_id: input_select.hallway_presence
    - conditions:
      - condition: state
        entity_id: input_select.hallway_presence
        state: leaving
      sequence:
      - choose:
        - conditions:
          - condition: trigger
            id: state
          sequence:
          - service: timer.start
            data:
              duration: 00:00:10
            target:
              entity_id: timer.hallway_transition_timer
        - conditions:
          - condition: trigger
            id: timer
          - condition: state
            entity_id: timer.hallway_transition_timer
            state: idle
          sequence:
          - service: input_select.select_option
            data:
              option: present
            target:
              entity_id: input_select.hallway_presence
            alias: Back to present
          - stop: Back to present
      - if:
        - condition: state
          entity_id: binary_sensor.hallway_human
          state: 'off'
        then:
        - service: input_select.select_option
          data:
            option: absent
          target:
            entity_id: input_select.hallway_presence
          alias: Select absent
  mode: queued
