- id: "1655228112348"
  alias: "Bedroom - Tv: Turn Off"
  description: ""
  trigger:
    - platform: state
      entity_id:
        - variable.bedroom_presence
      from: "on"
      to: "off"
  condition: []
  action:
    - type: turn_off
      device_id: 2488b94619cead138686380c1c220fec
      entity_id: remote.bedroom_tv
      domain: remote
  mode: single
- id: "1655749208565"
  alias: "Supply Closet - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.supply_closet_presence
      presence_indicator_entity_ids:
        - binary_sensor.supply_closet_door_contact
      presence_hint_entity_ids:
        - binary_sensor.supply_closet_shelly_input
      presence_timeout: 0
- id: "1655751397719"
  alias: "Toilet - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.toilet_presence
      presence_indicator_entity_ids:
        - binary_sensor.toilet_motion_occupancy
      presence_hint_entity_ids:
        - binary_sensor.toilet_shelly_input_1
        - binary_sensor.toilet_shelly_input_2
        - binary_sensor.toilet_door_contact
      presence_timeout: 180
- id: "1655751783256"
  alias: "Driveway - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.driveway_presence
      presence_indicator_entity_ids:
        - binary_sensor.driveway_doorbell_motion
        - binary_sensor.hallway_door_contact
      presence_hint_entity_ids:
        - binary_sensor.driveway_shelly_input
      presence_timeout: 120
- id: "1655752447329"
  alias: "Bedroom - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.bedroom_presence
      presence_indicator_entity_ids:
        - binary_sensor.bedroom_human_presence
        - binary_sensor.bedroom_motion_occupancy
      presence_hint_entity_ids:
        - binary_sensor.bedroom_shelly_input
        - binary_sensor.bedroom_door_contact
      presence_timeout: 60
- id: "1655752570246"
  alias: "Hallway - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.hallway_presence
      presence_hint_entity_ids:
        - binary_sensor.hallway_shelly_input
        - binary_sensor.toilet_door_contact
        - binary_sensor.living_room_door_contact
        - binary_sensor.driveway_shelly_input
        - binary_sensor.landing_motion_occupancy
        - binary_sensor.living_room_motion_occupancy
        - binary_sensor.toilet_motion_occupancy
      presence_timeout: 120
      presence_indicator_entity_ids:
        - binary_sensor.hallway_motion_occupancy
        - binary_sensor.hallway_door_contact
- id: "1655752840815"
  alias: "Landing - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.landing_presence
      presence_hint_entity_ids:
        - binary_sensor.landing_shelly_input
        - binary_sensor.office_door_contact
        - binary_sensor.baby_room_door_contact
        - binary_sensor.bedroom_door_contact
        - binary_sensor.bathroom_door_contact
      presence_indicator_entity_ids:
        - binary_sensor.baby_room_motion_occupancy
        - binary_sensor.bedroom_motion_occupancy
        - binary_sensor.laundry_room_motion_occupancy
        - binary_sensor.office_motion_occupancy
        - binary_sensor.bathroom_motion_occupancy
        - binary_sensor.landing_motion_occupancy
      presence_timeout: 120
- id: "1655752934365"
  alias: "Laundry Room - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.laundry_room_presence
      presence_indicator_entity_ids:
        - binary_sensor.laundry_room_motion_occupancy
      presence_hint_entity_ids:
        - binary_sensor.laundry_room_shelly_input
- id: "1655753137217"
  alias: "Office - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.office_presence
      presence_indicator_entity_ids:
        - binary_sensor.office_human_presence
        - binary_sensor.office_motion_occupancy
      presence_hint_entity_ids:
        - binary_sensor.office_door_contact
        - binary_sensor.office_shelly_input
- id: "1655753220517"
  alias: "Baby Room - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.baby_room_presence
      presence_indicator_entity_ids:
        - binary_sensor.baby_room_motion_occupancy
        - binary_sensor.baby_room_human_presence
      presence_hint_entity_ids:
        - binary_sensor.baby_room_shelly_input
        - binary_sensor.baby_room_door_contact
      presence_timeout: 60
- id: "1655755184933"
  alias: "Driveway - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.driveway_presence
      light_and_switch_entity_ids:
        - switch.driveway_shelly
      start_time: 00:00:00
      end_time: "23:59:59"
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 1000
- id: "1655798480666"
  alias: "Baby Room - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.baby_room_presence
      illuminance_entity_id: sensor.baby_room_motion_illuminance_2
      light_and_switch_entity_ids:
        - light.baby_room_light
        - switch.baby_room_power
      start_time: 00:00:00
      end_time: "23:59:59"
      illuminance_threshold: 40
- id: "1655798594467"
  alias: "Bedroom - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.bedroom_presence
      illuminance_entity_id: sensor.bedroom_motion_illuminance_3
      light_and_switch_entity_ids:
        - switch.bedroom_shelly
      start_time: 08:00:00
      end_time: "21:00:00"
      illuminance_threshold: 40
- id: "1655798724103"
  alias: "Hallway - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.hallway_presence
      illuminance_entity_id: sensor.hallway_motion_illuminance_lux
      light_and_switch_entity_ids:
        - light.hallway_lights
      start_time: 00:00:00
      end_time: "23:59:59"
      illuminance_threshold: 1000
- id: "1655799812663"
  alias: "Landing - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.landing_presence
      illuminance_entity_id: sensor.landing_motion_illuminance_lux
      illuminance_threshold: 60
      light_and_switch_entity_ids:
        - light.landing_lights
      start_time: 06:00:00
      end_time: "23:59:59"
- id: "1655799885346"
  alias: "Laundry Room - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.laundry_room_presence
      illuminance_entity_id: sensor.laundry_room_motion_illuminance_lux
      illuminance_threshold: 100
      light_and_switch_entity_ids:
        - switch.laundry_room_shelly
      start_time: 07:00:00
      end_time: "21:00:00"
- id: "1655800011564"
  alias: "Office - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.office_presence
      illuminance_entity_id: sensor.office_illuminance_illuminance_lux
      light_and_switch_entity_ids:
        - switch.office_shelly
      start_time: 07:00:00
      end_time: "23:00:00"
      illuminance_threshold: 40
- id: "1655800068148"
  alias: "Supply Closet - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.supply_closet_presence
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 200000
      light_and_switch_entity_ids:
        - switch.supply_closet_shelly
      start_time: 00:00:00
      end_time: "23:59:59"
- id: "1655800128048"
  alias: "Toilet - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.toilet_presence
      illuminance_entity_id: sensor.illuminance
      illuminance_threshold: 200000
      light_and_switch_entity_ids:
        - light.toilet_lights
      start_time: 00:00:00
      end_time: "23:59:59"
- id: "1655804642598"
  alias: "Bathroom - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.bathroom_presence
      presence_indicator_entity_ids:
        - binary_sensor.bathroom_motion_occupancy
        - binary_sensor.bathroom_human_presence
      presence_hint_entity_ids:
        - binary_sensor.bathroom_shelly_channel_1_input
        - binary_sensor.bathroom_shelly_channel_2_input
        - binary_sensor.bathroom_door_contact
      presence_timeout: 120
- id: "1655804684374"
  alias: "Bathroom - Light: Manage"
  description: ""
  use_blueprint:
    path: diy/auto_lights.yaml
    input:
      presence_entity_id: variable.bathroom_presence
      illuminance_entity_id: sensor.bathroom_motion_illuminance_lux
      light_and_switch_entity_ids:
        - light.bathroom_lights
      start_time: 07:00:00
      end_time: "23:00:00"
      illuminance_threshold: 140
- id: "1655926470261"
  alias: "Kitchen - Presence: Manage"
  description: ""
  use_blueprint:
    path: diy/presence.yaml
    input:
      presence_entity_id: variable.kitchen_presence
      presence_indicator_entity_ids:
        - binary_sensor.kitchen_human_presence
- id: "1657026314050"
  alias: "Bedroom - Sleeping: Manage"
  description: ""
  trigger:
    - platform: state
      entity_id:
        - sensor.bedroom_1_button_action
      to: "on"
      id: button_1
    - platform: state
      entity_id:
        - sensor.bedroom_2_button_action
      id: button_2
      to: "on"
    - platform: time
      at: "22:00:00"
      id: evening_time
    - platform: time
      at: 07:00:00
      id: morning_time
  condition: []
  action:
    - if:
        - condition: trigger
          id: button_1
      then:
        - wait_for_trigger:
            - platform: state
              entity_id:
                - sensor.bedroom_1_button_action
              to: "on"
          timeout: "1"
        - if:
            - condition: template
              value_template: "{{ wait.remaining > 0 }} "
          then:
            - service: input_boolean.turn_off
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
          else:
            - service: input_boolean.turn_on
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
    - if:
        - condition: trigger
          id: button_2
      then:
        - wait_for_trigger:
            - platform: state
              entity_id:
                - sensor.bedroom_2_button_action
              to: "on"
          timeout: "1"
        - if:
            - condition: template
              value_template: "{{ wait.remaining > 0 }} "
          then:
            - service: input_boolean.turn_off
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
          else:
            - service: input_boolean.turn_on
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
    - if:
        - condition: or
          conditions:
            - condition: trigger
              id: evening_time
            - condition: trigger
              id: morning_time
      then:
        - if:
            - condition: time
              after: "22:00:00"
              before: 07:00:00
          then:
            - service: input_boolean.turn_on
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
          else:
            - service: input_boolean.turn_off
              data: {}
              target:
                entity_id: input_boolean.bedroom_is_sleeping
  mode: single
- id: "1657638476657"
  alias: "Kitchen - Lights: Auto Off"
  description: ""
  trigger:
    - platform: state
      entity_id:
        - variable.kitchen_presence
      to: "off"
  condition: []
  action:
    - service: light.turn_off
      data:
        transition: 2
      target:
        entity_id: light.kitchen_lights
  mode: single
- id: "1658226673278"
  alias: "Adaptive lighting: toggle 'sleep mode'"
  description: ""
  trigger:
    - platform: state
      entity_id:
        - input_boolean.bedroom_is_sleeping
    - platform: homeassistant
      event: start
  variables:
    sleep_mode: "{{ states('input_boolean.bedroom_is_sleeping') }}"
  condition: []
  action:
    service: switch.turn_{{ sleep_mode }}
    entity_id:
      - switch.adaptive_lighting_sleep_mode_baby_room
      - switch.adaptive_lighting_sleep_mode_landing
      - switch.adaptive_lighting_sleep_mode_hallway
  mode: single
- id: "1664274065748"
  alias: Driveway - Doorbell Play Chime
  description: ""
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.driveway_doorbell_doorbell
      from: "off"
      to: "on"
  condition: []
  action:
    - parallel:
        - service: sonos.snapshot
          data:
            entity_id: media_player.woonkamer
        - service: sonos.snapshot
          data:
            entity_id: media_player.sonos_move
    - service: media_player.volume_set
      data:
        volume_level: 0.65
      target:
        entity_id:
          - media_player.woonkamer
          - media_player.sonos_move
    - service: media_player.play_media
      data:
        media_content_type: music
        media_content_id: http://hypervisor:8123/local/sounds_sounds_ring_button_Chime.mp3
      target:
        entity_id:
          - media_player.woonkamer
          - media_player.sonos_move
    - delay:
        hours: 0
        minutes: 0
        seconds: 4
        milliseconds: 0
    - parallel:
        - service: sonos.restore
          data:
            entity_id: media_player.woonkamer
        - service: sonos.restore
          data:
            entity_id: media_player.sonos_move
  mode: single
- id: "1674554618790"
  alias: Apple Watch Location 1
  trace:
    stored_traces: 300
  description: ""
  trigger:
    - platform: mqtt
      topic: home/location/bluetooth-00:00:00:00:00:00
      id: mqtt
    - platform: time_pattern
      seconds: /10
      id: time
  condition: []
  action:
    - if:
        - condition: trigger
          id: time
      then:
        - if:
            - condition: template
              value_template:
                "{% set the_past = state_attr('variable.apple_watch_1_location',
                'last_updated') %}

                {% set the_present = now() %}

                {% set seconds_passed = as_timestamp(the_present)-as_timestamp(the_past)
                %}


                {{ seconds_passed > 120 }}"
          then:
            - service: variable.set_variable
              data:
                variable: apple_watch_1_location
                value: away
                attributes:
                  next_location: away
                  next_location_iteration: 0
                  next_location_duration: 0
                  icon: mdi:home-outline
                  last_updated: "{{ now() }}"
        - stop: Done checking away status
      alias: Check for away status
    - if:
        - condition: template
          value_template:
            "{{ trigger.payload_json.location == states('variable.apple_watch_1_location')
            }}"
      then:
        - service: variable.set_variable
          data:
            variable: apple_watch_1_location
            attributes:
              next_location: "{{ states('variable.apple_watch_1_location') }}"
              next_location_iteration: 0
              icon: mdi:home
              last_updated: "{{ now() }}"
        - stop: Nothing changed
      alias: same location
    - if:
        - condition: template
          value_template: "{{ trigger.payload_json.guesses[0].probability < 0.5 }}"
      then:
        - service: variable.set_variable
          data:
            variable: apple_watch_1_location
            attributes:
              next_location: "{{ states('variable.apple_watch_1_location') }}"
              next_location_iteration: 0
              icon: mdi:home
              last_updated: "{{ now() }}"
        - stop: Probability too low
      alias: low probability
    - if:
        - condition: template
          value_template:
            "{{ trigger.payload_json.location != state_attr('variable.apple_watch_1_location',
            'next_location') }}"
      then:
        - service: variable.set_variable
          data:
            variable: apple_watch_1_location
            attributes:
              next_location: "{{ trigger.payload_json.location }}"
              next_location_iteration: 0
              icon: mdi:home
              last_updated: "{{ now() }}"
      alias: Update next location
    - service: variable.set_variable
      data:
        variable: apple_watch_1_location
        attributes:
          next_location_iteration:
            "{{ (state_attr('variable.apple_watch_1_location',
            'next_location_iteration') | int(default=0)) + 1 }}"
      alias: Next location iteration increment
    - if:
        - condition: template
          value_template:
            "{{ (state_attr('variable.apple_watch_1_location', 'next_location_iteration')
            | int(default=0)) > 1 }}"
      then:
        - service: variable.set_variable
          data:
            variable: apple_watch_1_location
            value:
              "{{ state_attr('variable.apple_watch_1_location', 'next_location')
              }}"
            attributes:
              next_location:
                "{{ state_attr('variable.apple_watch_1_location', 'next_location')
                }}"
              next_location_iteration: 0
              icon: mdi:home
              last_updated: "{{ now() }}"
      alias: Change location
  mode: single
- id: "1687445709673"
  alias: Living Room Dining Table - Lights
  description: ""
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_dining_table_human_presence
      light_and_switch_entity_ids:
        - light.living_room_dining_table_light
      illuminance_entity_id: sensor.living_room_illuminance
      away_timer_entity_id: timer.living_room_dining_table_away_timer
      away_timer_duration:
        hours: 0
        minutes: 0
        seconds: 30
      manual_timer_entity_id: timer.living_room_dining_table_manual_timer
      manual_timer_duration:
        hours: 1
        minutes: 0
        seconds: 0
      illuminance_threshold: 300
- id: "1687446669605"
  alias: Living Room Kitchen - Lights
  description: ""
  use_blueprint:
    path: diy/better_auto_lights.yaml
    input:
      presence_entity_id: binary_sensor.living_room_kitchen_human_presence
      light_and_switch_entity_ids:
        - light.kitchen_lights
      illuminance_entity_id: sensor.living_room_illuminance
      illuminance_threshold: 300
      away_timer_entity_id: timer.living_room_kitchen_away_timer
      away_timer_duration:
        hours: 0
        minutes: 0
        seconds: 30
      manual_timer_entity_id: timer.living_room_kitchen_manual_timer
      manual_timer_duration:
        hours: 2
        minutes: 0
        seconds: 0
