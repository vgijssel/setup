name: "Setup Bazel"
description: "Setup the CI to work properly with Bazel"
runs:
  using: "composite"
  steps:
    - uses: pat-s/always-upload-cache@v3.0.11
      id: bazel-cache
      with:
        path: |
          tmp/bazel/disk_cache
          tmp/bazel/repository_cache
        key: bazel-cache-${{ runner.os }}-${{ github.job }}-${{ github.sha }}
        restore-keys: bazel-cache-${{ runner.os }}-${{ github.job }}-

    - name: Load secret
      uses: 1password/load-secrets-action@v1
      with:
        # Export loaded secrets as environment variables
        export-env: true
      env:
        OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONEPASSWORD_SERVICE_ACCOUNT_TOKEN_PROD }}
        BUILDBUDDY_API_KEY: op://vgijssel-prod/buildbuddy-api-key/password

    - name: Create local.bazelrc file
      run: |
        echo "build --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY" > local.bazelrc
