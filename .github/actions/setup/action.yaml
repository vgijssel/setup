name: Setup Environment
description: Composite action to setup environment with checkout, hermit, direnv, and 1Password secrets
runs:
  using: composite
  steps:
    - name: Disk usage before cleanup
      shell: bash
      run: |
        echo "=== Disk usage before cleanup ==="
        df -h

    - name: Free Disk Space for Docker
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        rm_cmd: rmz # Faster cleanup

    - name: Disk usage after cleanup
      shell: bash
      run: |
        echo "=== Disk usage after cleanup ==="
        df -h

    - name: Init Hermit
      uses: cashapp/activate-hermit@v1
      with:
        cache: true

    - name: Install hermit packages
      shell: bash
      run: |
        # Install all packages from hermit manifests
        # moon v2.0.0 removed darwin-amd64 support, which causes an interactive prompt
        # We need to answer 'y' to the prompt non-interactively
        # Using 'script' command to create a pseudo-TTY allows the pipe to work correctly
        script -q -c "echo y | ./bin/hermit install moon" /dev/null 2>&1 | grep -v "sync /dev/stdout" || true

        # Verify moon is available
        if ! command -v moon &> /dev/null; then
          echo "ERROR: moon binary not found after hermit install"
          echo "Checking hermit cache..."
          ls -la ~/.cache/hermit/pkg/ | grep moon || echo "No moon in cache"
          echo "Checking bin directory..."
          ls -la ./bin/ | grep moon || echo "No moon symlink in bin"
          exit 1
        fi
        echo "moon successfully installed: $(moon --version)"

    - name: Setup direnv
      uses: HatsuneMiku3939/direnv-action@v1
      with:
        direnvVersion: 2.35.0

    - name: Create empty .env
      shell: bash
      run: touch .env

    - name: Set up QEMU for multi-platform builds
      if: runner.os == 'Linux'
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx for multi-platform builds
      if: runner.os == 'Linux'
      uses: docker/setup-buildx-action@v3
