language: bash
type: library

tags:
  - devcontainer
  - docker
  - coder

fileGroups:
  sources:
    - "Dockerfile"
    - "entrypoint.sh"
    - "version.txt"
  scripts:
    - "scripts/*.sh"

tasks:
  hermit-bundle:
    command: hermit-bundle dist python3 node
    inputs:
      - "@group(hermit_bundle_bin)"
      - "@group(python_bin)"
      - "@group(node_bin)"
    outputs:
      - "dist/hermit-bundle.tar.gz"

  build:
    command: scripts/build.sh $MOON_TASK_HASH
    deps:
      - ~:hermit-bundle
      - coder-logstream-process:build
      - docker:buildx_run
    inputs:
      - "@group(sources)"
      - "@group(scripts)"
      - "dist/hermit-bundle.tar.gz"
      - "/workspaces/setup/libs/coder-logstream-process/dist/coder-logstream-process.pex"
    outputs:
      - "dist/image.json"

  test:
    command: bats tests/devcontainer-builder.bats
    deps:
      - ~:build
    inputs:
      - "@group(sources)"
      - "@group(scripts)"
      - "tests/**/*.bats"
      - "dist/image.json"

  run:
    command: scripts/run.sh
    deps:
      - ~:build
    options:
      runInCI: false
    local: true

  push-local:
    command:
      - bash
      - -c
      - 'kubectl port-forward -n coder svc/coder-registry 5000:5000 & sleep 3 && VERSION=$(cat version.txt | tr -d "\n") && docker push localhost:5000/devcontainer-builder:${VERSION} && docker push localhost:5000/devcontainer-builder:latest && kill %1'
    deps:
      - ~:build
    options:
      runInCI: false
      shell: false

  push-ghcr:
    command:
      - bash
      - -c
      - 'VERSION=$(cat version.txt | tr -d "\n") && docker push ghcr.io/vgijssel/setup/devcontainer-builder:${VERSION} && docker push ghcr.io/vgijssel/setup/devcontainer-builder:latest'
    deps:
      - ~:build
    options:
      runInCI: false
      shell: false

  release:
    command:
      - bash
      - -c
      - 'VERSION=$(cat version.txt | tr -d "\n") && COMMIT_SHA=$(git rev-parse --short HEAD) && docker tag ghcr.io/vgijssel/setup/devcontainer-builder:${VERSION} ghcr.io/vgijssel/setup/devcontainer-builder:${VERSION}-${COMMIT_SHA} && docker push ghcr.io/vgijssel/setup/devcontainer-builder:${VERSION} && docker push ghcr.io/vgijssel/setup/devcontainer-builder:${VERSION}-${COMMIT_SHA} && docker push ghcr.io/vgijssel/setup/devcontainer-builder:latest && echo "Released version ${VERSION} (${COMMIT_SHA})"'
    deps:
      - ~:build
    options:
      runInCI: false
      shell: false
