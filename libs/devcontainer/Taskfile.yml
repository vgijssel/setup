version: "3"

tasks:
  start:
    desc: Create development environment with git worktree and docker container
    requires:
      vars: [NAME]
    cmds:
      - mkdir -p ../../workspaces
      - git worktree add ../../workspaces/{{.NAME}} HEAD
      - cp -v ../../.env ../../workspaces/{{.NAME}}/
      - docker build -t devcontainer .
      - docker run -d --name {{.NAME}}-dev -v $(pwd)/../../workspaces/{{.NAME}}:/opt/setup devcontainer
      - sleep 2 # TODO: better wait for container to be ready
      - docker exec -d {{.NAME}}-dev tmux new-session -d -s main
      - sleep 1 # TODO: better wait for tmux to be ready
      - docker exec {{.NAME}}-dev tmux send-keys -t main "echo hello" C-m

  stop:
    desc: Stop and cleanup development environment
    requires:
      vars: [NAME]
    cmds:
      - docker stop {{.NAME}}-dev 2>/dev/null || echo "Container {{.NAME}}-dev not running"
      - docker rm {{.NAME}}-dev 2>/dev/null || echo "Container {{.NAME}}-dev not found"
      - git worktree remove ../../workspaces/{{.NAME}} 2>/dev/null || echo "Worktree ../../workspaces/{{.NAME}} not found"
