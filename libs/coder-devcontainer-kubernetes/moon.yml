language: javascript
layer: library
dependsOn:
  - devcontainer
  - fleet-mcp
tags:
  - coder
  - devcontainer
  - terraform
  - kubernetes
  - development-environment
tasks:
  init:
    command: terraform init -backend=false
    options:
      cache: false
    # TODO: currently too large to cache with bazel-remote and Backblaze B2
    #    outputs:
    #      - .terraform
    inputs:
      - glob: ./**/*.tf
      - glob: ./**/*.hcl
      - "!.terraform/**"

  test:
    command: terraform validate
    deps:
      - ~:init
    options:
      cache: true
    inputs:
      - glob: ./**/*.tf
      - glob: ./**/*.hcl
      - file: ./supervisord.conf
      - file: ./Taskfile.yml
      - file: ./version.txt
      - "!.terraform/**"

  workspace_test:
    command: bats
    args:
      - tests/workspace-test.bats
    deps:
      - ~:test
    options:
      cache: true
      runInCI: false
    inputs:
      - file: ./tests/goss.yaml
      - file: ./tests/workspace-test.bats
