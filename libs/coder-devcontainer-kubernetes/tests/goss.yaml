# Goss tests for validating Coder workspace health
# Run with: WORKSPACE_NAME=<name> goss -g goss-workspace.yaml validate --retry-timeout 10m --sleep 15s
#
# Note: coder list -o json returns workspace data with:
#   - .latest_build.status for build status (running, pending, etc)
#   - .health.healthy for overall health boolean
#   - .latest_build.resources[] | select(.agents) for resources with agents

command:
  workspace_running:
    title: Workspace is running
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].latest_build.status' | tr -d '\n'
    exit-status: 0
    stdout: running
    timeout: 30000

  workspace_healthy:
    title: Workspace is healthy (all apps healthy)
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].health.healthy' | tr -d '\n'
    exit-status: 0
    stdout: "true"
    timeout: 30000

  agent_connected:
    title: Coder agent is connected
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].latest_build.resources[] | select(.agents) | .agents[0].status' | tr -d '\n'
    exit-status: 0
    stdout: connected
    timeout: 30000

  fleet_mcp_app_healthy:
    title: Fleet MCP app is healthy
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].latest_build.resources[] | select(.agents) | .agents[0].apps[] | select(.slug == "fleet-mcp") | .health' | tr -d '\n'
    exit-status: 0
    stdout: healthy
    timeout: 30000

  claude_code_app_exists:
    title: Claude Code app is available
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].latest_build.resources[] | select(.agents) | .agents[0].apps[] | select(.slug == "ccw") | .slug' | tr -d '\n'
    exit-status: 0
    stdout: ccw
    timeout: 30000

  claude_code_app_healthy:
    title: Claude Code app is healthy
    exec: |
      coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].latest_build.resources[] | select(.agents) | .agents[0].apps[] | select(.slug == "ccw") | .health' | tr -d '\n'
    exit-status: 0
    stdout: healthy
    timeout: 30000

  devpod_builder_job_completed:
    title: DevPod builder job completed successfully
    exec: |
      WORKSPACE_ID=$(coder list -o json --search "name:{{.Env.WORKSPACE_NAME}}" | jq -r '.[0].id')
      kubectl get jobs -n coder-workspace -l "com.coder.workspace.id=${WORKSPACE_ID}" -o jsonpath='{.items[0].status.succeeded}' 2>/dev/null || echo "0"
    exit-status: 0
    stdout:
      - "1"
    timeout: 60000
