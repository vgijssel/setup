apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-gateway-ingress
  annotations:
    policies.kyverno.io/title: Generate Gateway IngressClass and Mirror Ingresses
    policies.kyverno.io/category: Networking
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: IngressClass, Ingress
    policies.kyverno.io/description: >-
      Creates gateway-specific IngressClasses for tenant IngressClasses and mirrors ingresses
      with internal-networking/expose label to use gateway ingress controllers for public internet exposure.
spec:
  generateExisting: true
  rules:
    # Rule 1: Generate gateway IngressClass for each tenant-* IngressClass
    - name: generate-gateway-ingressclass
      match:
        any:
          - resources:
              kinds:
                - IngressClass
      preconditions:
        all:
          # Only process ingresses classes matching tenant-* pattern (starts with "tenant-")
          - key: "{{"{{"}} starts_with(request.object.metadata.name, 'tenant-') {{"}}"}}"
            operator: Equals
            value: true
          # Don't process gateway classes themselves to avoid recursion (ends with "-gateway")
          - key: "{{"{{"}} ends_with(request.object.metadata.name, '-gateway') {{"}}"}}"
            operator: NotEquals
            value: true
      generate:
        synchronize: true
        apiVersion: networking.k8s.io/v1
        kind: IngressClass
        name: "{{"{{ request.object.metadata.name }}"}}-gateway"
        data:
          metadata:
            labels:
              app.kubernetes.io/managed-by: kyverno
              kyverno.io/generated-by: generate-gateway-ingress
              internal-networking.io/type: gateway
            annotations:
              # Metadata for identifying gateway IngressClasses
              internal-networking.io/gateway-node-selector: {{ toJson .Values.gatewayNodeSelector | quote }}
          spec:
            # Use a dedicated gateway controller - a separate nginx-ingress deployment
            # must be created that runs on gateway nodes and uses this controller name
            controller: {{ .Values.gatewayControllerName | quote }}
    # Rule 2: Mirror ingresses with internal-networking/expose label to gateway IngressClass
    - name: mirror-ingress-to-gateway
      match:
        any:
          - resources:
              kinds:
                - Ingress
      preconditions:
        all:
          # Only process ingresses with expose label set to true
          - key: '{{"{{ request.object.metadata.labels.\"internal-networking/expose\" || '''' }}"}}'
            operator: Equals
            value: "true"
          # Don't process gateway ingresses themselves to avoid recursion (ends with "-gateway")
          - key: "{{"{{"}} ends_with(request.object.metadata.name, '-gateway') {{"}}"}}"
            operator: NotEquals
            value: true
          # Skip if ingress has skip annotation
          - key: '{{"{{ request.object.metadata.annotations.\"internal-networking/skip-gateway-mirror\" || ''false'' }}"}}'
            operator: NotEquals
            value: "true"
      generate:
        synchronize: true
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        name: "{{"{{ request.object.metadata.name }}"}}-gateway"
        namespace: "{{"{{ request.object.metadata.namespace }}"}}"
        data:
          metadata:
            labels:
              # Add internal-networking label for external-dns to track
              internal-networking: "true"
              app.kubernetes.io/managed-by: kyverno
              kyverno.io/generated-by: generate-gateway-ingress
            annotations:
              internal-networking.io/original-ingress: "{{"{{ request.object.metadata.name }}"}}"
          spec:
            # Switch to gateway IngressClass
            ingressClassName: "{{"{{ request.object.spec.ingressClassName }}"}}-gateway"
            # Copy rules from the original ingress
            rules: "{{"{{ request.object.spec.rules }}"}}"
            # Copy TLS config if present (use merge to conditionally include)
            tls: "{{"{{ request.object.spec.tls }}"}}"
