apiVersion: tf.upbound.io/v1beta1
kind: Workspace
metadata:
  name: cloudflare-tunnel-workspace
spec:
  forProvider:
    source: Inline
    module: |
      terraform {
        required_providers {
          cloudflare = {
            source = "cloudflare/cloudflare"
            version = "5.9.0"
          }
        }
      }

      variable "cloudflare_api_token" {
        description = "Cloudflare API token"
        type        = string
        sensitive   = true
      }

      variable "cloudflare_account_id" {
        description = "Cloudflare account ID"
        type        = string
      }

      variable "tunnel_name" {
        description = "Cloudflare tunnel name"
        type        = string
      }

      variable "tunnel_hostname" {
        description = "Hostname for the tunnel"
        type        = string
      }

      variable "tunnel_service" {
        description = "Service URL for the tunnel"
        type        = string
      }

      provider "cloudflare" {
        api_token = var.cloudflare_api_token
      }

      resource "cloudflare_tunnel" "example" {
        account_id = var.cloudflare_account_id
        name       = var.tunnel_name
        secret     = base64sha256("${var.tunnel_name}-secret")
      }

      resource "cloudflare_tunnel_config" "example" {
        account_id = var.cloudflare_account_id
        tunnel_id  = cloudflare_tunnel.example.id

        config {
          ingress_rule {
            hostname = var.tunnel_hostname
            service  = var.tunnel_service
          }
          
          ingress_rule {
            service = "http_status:404"
          }
        }
      }

      output "tunnel_id" {
        value = cloudflare_tunnel.example.id
      }

      output "tunnel_token" {
        value = cloudflare_tunnel.example.tunnel_token
        sensitive = true
      }
    vars:
      - key: cloudflare_api_token
        source: Secret
        secretKeyRef:
          name: cloudflare-tunnel
          key: credential
      - key: cloudflare_account_id
        value: { { .Values.cloudflare.accountId | quote } }
      - key: tunnel_name
        value: { { .Values.tunnel.name | quote } }
      - key: tunnel_hostname
        value: { { .Values.tunnel.hostname | quote } }
      - key: tunnel_service
        value: { { .Values.tunnel.service | quote } }
  writeConnectionSecretsToRef:
    name: cloudflare-tunnel-outputs
    namespace: { { .Release.Namespace } }
  providerConfigRef:
    name: default
