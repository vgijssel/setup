#!/bin/sh

# This script modifies ~/.ssh/known_hosts to ensure GitHub's SSH keys are present
# It reads from the ssh_known_hosts file and appends any missing entries

# Ensure .ssh directory exists with correct permissions
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Create known_hosts if it doesn't exist
touch ~/.ssh/known_hosts
chmod 600 ~/.ssh/known_hosts

# Read the GitHub known hosts from our source file
SOURCE_FILE="{{ .chezmoi.sourceDir }}/ssh_known_hosts"

# Check if the source file exists
if [ ! -f "$SOURCE_FILE" ]; then
    echo "Warning: ssh_known_hosts source file not found at $SOURCE_FILE" >&2
    exit 0
fi

# Read each line from the source file and add if not already present
while IFS= read -r line; do
    # Skip empty lines and comments
    if [ -z "$line" ] || [ "${line#\#}" != "$line" ]; then
        continue
    fi

    # Extract the hostname (first field)
    hostname=$(echo "$line" | cut -d' ' -f1)

    # Check if this exact line already exists in known_hosts
    if ! grep -Fxq "$line" ~/.ssh/known_hosts; then
        echo "$line" >> ~/.ssh/known_hosts
    fi
done < "$SOURCE_FILE"