#!/bin/bash
set -euo pipefail

# Make bwrap setuid for vault-shell in Kubernetes containers
# Hash: {{ "bwrap-setuid-v1" | sha256sum }}

echo "üîß Configuring bwrap for namespace isolation..."

# Check if bwrap exists
if ! command -v bwrap >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  bwrap not found, skipping setuid configuration"
    exit 0
fi

# Check if bwrap is already setuid
if [[ -u "$(command -v bwrap)" ]]; then
    echo "‚úì bwrap is already setuid"
    exit 0
fi

# Make bwrap setuid
# This is required for vault-shell to work in Coder workspaces running in Kubernetes
# The container runs in a user namespace, and non-setuid bwrap cannot create nested
# user namespaces. With setuid, bwrap can bypass this limitation.
echo "Setting setuid bit on bwrap..."
sudo chmod u+s "$(command -v bwrap)"

echo "‚úì bwrap configured successfully"
