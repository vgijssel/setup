#!/usr/bin/env bash
set -euo pipefail

{{- $setup_dir := env "SETUP_DIR" }}
{{- $devcontainer_file := joinPath $setup_dir ".devcontainer" "devcontainer.json" }}
{{- $devcontainer := include $devcontainer_file | fromJson }}

OUTPUT_DIR="${HOME}/.vscode-server/extensions"

echo "ðŸ“¦ Installing VSCode extensions from {{ $devcontainer_file }}"
echo "Output directory: ${OUTPUT_DIR}"

mkdir -p "${OUTPUT_DIR}"

{{ range $devcontainer.customizations.vscode.extensions -}}
echo "Installing extension: {{ . }}"

# Install for VSCode (remote server)
if ! code-server --extensions-dir "${OUTPUT_DIR}" --install-extension "{{ . }}"; then
  echo "âŒ Failed to install {{ . }} for VSCode" >&2
  exit 1
fi
echo "âœ“ Successfully installed {{ . }} for VSCode"

# Install for code-server (default location)
if ! code-server --install-extension "{{ . }}"; then
  echo "âŒ Failed to install {{ . }} for code-server" >&2
  exit 1
fi
echo "âœ“ Successfully installed {{ . }} for code-server"

{{ end -}}
echo "âœ… VSCode extensions installed successfully"
