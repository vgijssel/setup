language: python
layer: library
stack: backend
tags:
  - python
  - build
  - docker
tasks:
  run:
    command: uv run cross

  test:
    command: uv run pytest tests/ -v
    inputs:
      - "@files(python_sources)"
      - "@files(python_tests)"
      - "@files(python_configs)"
      - "@globs(python_bin)"
      - "@globs(uv_bin)"
    options:
      cache: true
      mergeArgs: replace

  .integration:
    command: uv run cross --platform $CROSS_OS/$CROSS_ARCH echo "$CROSS_ARCH" > dist/$CROSS_OS-$CROSS_ARCH.txt
    inputs:
      - "@files(python_sources)"
      - "@files(python_configs)"
    options:
      cache: true
      runInCI: skip
    outputs:
      - dist/$CROSS_OS-$CROSS_ARCH.txt

  integration_test_linux_amd64:
    extends: .integration
    env:
      CROSS_OS: linux
      CROSS_ARCH: amd64
      PYTHONUNBUFFERED: "1"
    options:
      runInCI: true

  integration_test_linux_arm64:
    extends: .integration
    env:
      CROSS_OS: linux
      CROSS_ARCH: arm64
    options:
      runInCI: true
