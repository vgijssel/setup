apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-virtual-ingress
  annotations:
    policies.kyverno.io/title: Resolve Virtual Ingress Service from Annotations
    policies.kyverno.io/category: Networking
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Ingress
    policies.kyverno.io/description: >-
      Resolves Ingress resources that use virtual-ingress/* annotations for dynamic service lookup.
      When an Ingress has virtual-ingress/cluster-name and virtual-ingress/service-name annotations,
      this policy queries the Kubernetes API to find matching services and creates a Service resource
      with a predictable name that points to the real mirrored service.
    # Hash of immutable fields - used by pre-upgrade hook to detect changes
    virtual-ingress/immutable-hash: {{ include "virtual-ingress.policyHash" . | quote }}
  labels:
    {{- include "virtual-ingress.labels" . | nindent 4 }}
spec:
  generateExisting: {{ .Values.policy.generateExisting }}
  background: {{ .Values.policy.backgroundScan }}
  rules:
    # Generate Service resource pointing to the real mirrored service
    - name: generate-virtual-service
      match:
        any:
          - resources:
              kinds:
                - Ingress
      # Only process ingresses with virtual-ingress annotations
      preconditions:
        all:
          # Must have cluster-name annotation
          - key: "{{"{{ request.object.metadata.annotations.\"virtual-ingress/cluster-name\" || '' }}"}}"
            operator: NotEquals
            value: ""
          # Must have service-name annotation
          - key: "{{"{{ request.object.metadata.annotations.\"virtual-ingress/service-name\" || '' }}"}}"
            operator: NotEquals
            value: ""
      # Query for the real service using labels
      context:
        - name: serviceNamespace
          variable:
            jmesPath: "request.object.metadata.namespace"
        - name: clusterName
          variable:
            jmesPath: 'request.object.metadata.annotations."virtual-ingress/cluster-name" || `""`'
        - name: serviceName
          variable:
            jmesPath: 'request.object.metadata.annotations."virtual-ingress/service-name" || `""`'
        # Query services with matching labels
        - name: matchingServices
          apiCall:
            urlPath: "/api/v1/namespaces/{{"{{serviceNamespace}}"}}/services?labelSelector=cluster.x-k8s.io/cluster-name%3D{{"{{clusterName}}"}},cluster.x-k8s.io/tenant-service-name%3D{{"{{serviceName}}"}}"
            jmesPath: "items"
        # Get the first (and should be only) matching service
        - name: targetService
          variable:
            jmesPath: "matchingServices[0] || `null`"
        - name: targetServiceName
          variable:
            jmesPath: "targetService.metadata.name || `""`"
        - name: targetServicePort
          variable:
            jmesPath: "targetService.spec.ports[0].port || `80`"
      # Generate a Service that points to the target
      generate:
        synchronize: {{ .Values.policy.synchronize }}
        apiVersion: v1
        kind: Service
        name: "{{"{{ request.object.spec.rules[0].http.paths[0].backend.service.name }}"}}"
        namespace: "{{"{{ serviceNamespace }}"}}"
        data:
          metadata:
            labels:
              virtual-ingress.io/source-ingress: "{{"{{ request.object.metadata.name }}"}}"
              virtual-ingress.io/cluster-name: "{{"{{ clusterName }}"}}"
              virtual-ingress.io/service-name: "{{"{{ serviceName }}"}}"
              app.kubernetes.io/managed-by: kyverno
            annotations:
              virtual-ingress/target-service: "{{"{{ targetServiceName }}"}}"
          spec:
            type: ExternalName
            externalName: "{{"{{ targetServiceName }}"}}}.{{"{{ serviceNamespace }}"}}. svc.cluster.local"
            ports:
              - port: "{{"{{ request.object.spec.rules[0].http.paths[0].backend.service.port.number }}"}}"
                targetPort: "{{"{{ targetServicePort }}"}}"
                protocol: TCP
