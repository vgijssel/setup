---
- name: Prepare
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Wait for systemd to be ready
      ansible.builtin.raw: |
        timeout 30 bash -c 'until systemctl is-system-running 2>/dev/null | grep -qE "running|degraded"; do sleep 1; done'
      changed_when: false
      failed_when: false

    - name: Install Python and prerequisites
      ansible.builtin.raw: |
        apt-get update
        apt-get install -y python3 python3-apt sudo locales
      changed_when: false

    - name: Generate locales
      ansible.builtin.raw: |
        sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen
        locale-gen
      changed_when: false

    - name: Gather facts
      ansible.builtin.setup:
