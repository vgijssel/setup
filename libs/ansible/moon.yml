id: ansible
language: javascript
layer: library
tags:
  - scope.lib
  - type.infrastructure
  - ansible
tasks:
  test:
    command: |
      if [ ! -d ".venv" ]; then
        python3 -m venv .venv
        .venv/bin/pip install --upgrade pip
        .venv/bin/pip install -r requirements-dev.txt
      fi
      for role in roles/*/; do
        role_name=$(basename "$role")
        echo "Testing role: $role_name"
        cd "$role" && ../../.venv/bin/molecule test && cd ../..
      done
    inputs:
      - roles/**/*.yml
      - roles/**/*.yaml
      - roles/**/*.py
      - requirements.yml
      - requirements-dev.txt
    outputs: []
  test-role:
    command: |
      if [ -z "$ROLE" ]; then
        echo "Error: ROLE environment variable must be set"
        echo "Usage: ROLE=common moon run ansible:test-role"
        exit 1
      fi
      if [ ! -d ".venv" ]; then
        python3 -m venv .venv
        .venv/bin/pip install --upgrade pip
        .venv/bin/pip install -r requirements-dev.txt
      fi
      cd "roles/$ROLE" && ../../.venv/bin/molecule test
    inputs:
      - roles/**/*.yml
      - roles/**/*.yaml
      - requirements.yml
      - requirements-dev.txt
    outputs: []
    local: true
    env:
      ROLE: ""
  lint:
    command: trunk check --all
    inputs:
      - "**/*.yml"
      - "**/*.yaml"
    outputs: []
