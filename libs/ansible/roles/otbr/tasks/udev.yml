---
# USB Device Udev Rules for Thread Radio
# Creates persistent symlink for Nabu Casa Thread radio

- name: Deploy Thread radio udev rules
  ansible.builtin.template:
    src: 99-thread-radio.rules.j2
    dest: /etc/udev/rules.d/99-thread-radio.rules
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: reload udev
  register: udev_rules

- name: Reload udev rules immediately
  ansible.builtin.shell:
    cmd: udevadm control --reload-rules && udevadm trigger
  become: true
  when: udev_rules.changed

- name: Verify Thread radio device exists
  ansible.builtin.stat:
    path: "{{ otbr_usb_device }}"
  register: thread_radio_device

- name: Warn if Thread radio not detected
  ansible.builtin.debug:
    msg: "WARNING: Thread radio device {{ otbr_usb_device }} not found. OTBR will not function."
  when: not thread_radio_device.stat.exists
