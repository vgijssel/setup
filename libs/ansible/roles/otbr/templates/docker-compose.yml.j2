# OTBR (Open Thread Border Router) Docker Compose Configuration
# Managed by Ansible - DO NOT EDIT MANUALLY
# Deployed to {{ otbr_compose_dir }}/docker-compose.yml

services:
  otbr:
    container_name: {{ otbr_container_name }}
    image: {{ otbr_image }}
    hostname: {{ otbr_container_name }}
    restart: unless-stopped

    # Fix hostname resolution for sudo commands inside container
    extra_hosts:
      - "{{ otbr_container_name }}:127.0.0.1"

    # Network mode: host required for Thread border routing
    # OTBR needs direct access to network interfaces for:
    # - mDNS/DNS-SD service discovery
    # - IPv6 neighbor discovery
    # - Thread mesh networking
    network_mode: host

    # Privileged mode required for:
    # - Network namespace management
    # - iptables/ip6tables manipulation
    # - Thread radio access
    privileged: true

    environment:
      # Timezone
      TZ: {{ otbr_timezone }}

      # Thread radio configuration
      # Radio URL format: spinel+hdlc+uart://DEVICE?uart-baudrate=BAUDRATE
      RADIO_URL: "{{ otbr_radio_url }}"

      # Backbone interface for Thread network
      BACKBONE_IF: {{ otbr_backbone_interface }}

      # Thread network prefix (ULA - Unique Local Address)
      THREAD_PREFIX: "{{ otbr_thread_prefix }}"

{% if otbr_nat64_enabled %}
      # NAT64 for IPv4-only devices
      NAT64: "1"
{% else %}
      # NAT64 disabled - using native IPv6
      NAT64: "0"
{% endif %}

      # Web interface port
      WEB_PORT: {{ otbr_web_port }}

    volumes:
      # Persistent data for Thread network credentials
      - {{ otbr_data_dir }}:/var/lib/thread

    devices:
      # Thread radio USB device
      # Note: Pass the actual device, not the symlink - Docker doesn't follow symlinks
      - {{ otbr_usb_device }}:{{ otbr_usb_device }}

    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN

    # Disable seccomp for full Thread networking support
    security_opt:
      - seccomp:unconfined
