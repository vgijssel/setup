- name: Install whois for mkpasswd
  ansible.builtin.package:
    name: whois
    state: present
  become: true

- name: Ensure group "sudo" exists
  ansible.builtin.group:
    name: sudo
    state: present
  become: true

- name: Set root password
  user:
    name: root
    password: "{{ root_user_password_encrypted }}"
  become: true

- name: Remove authorized keys for root
  ansible.builtin.file:
    path: /root/.ssh/authorized_keys
    state: absent
  become: true

- name: Create maarten user
  user:
    name: maarten
    password: "{{ maarten_user_password_encrypted }}"
    state: present
    shell: /bin/bash
    groups: [sudo]
    create_home: true
  become: true

- name: Set authorized key for maarten
  ansible.posix.authorized_key:
    user: maarten
    state: present
    key: "{{ maarten_user_public_key }}"
    exclusive: true
  become: true

# Note: DietPi requires NOPASSWD for unattended Ansible runs via SSH key
# The user can still manually enter password when using sudo interactively
- name: Configure sudo for maarten user
  ansible.builtin.copy:
    content: |
      # This file is managed by Ansible
      # Allow maarten passwordless sudo (required for Ansible SSH key auth)
      maarten ALL=(ALL:ALL) NOPASSWD: ALL
    dest: /etc/sudoers.d/99_maarten-sudo
    owner: root
    group: root
    mode: "0440"
    validate: /usr/sbin/visudo -cf %s
  become: true

- name: Remove ubuntu user
  ansible.builtin.user:
    name: ubuntu
    state: absent
    remove: yes
  become: true

- name: Set sudo timeout to 5 minutes
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: ^Defaults passwd_timeout=
    line: Defaults passwd_timeout=5
    validate: /usr/sbin/visudo -cf %s
  become: true

# Note: tty_tickets is not supported by sudo-rs (used in Ubuntu 25.10+)
# Skip this on systems without traditional sudo
- name: Check if sudo-rs is installed
  ansible.builtin.command: dpkg -l sudo-rs
  register: sudo_rs_check
  changed_when: false
  failed_when: false

- name: Remove tty_tickets if sudo-rs is installed (not supported)
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: absent
    line: Defaults tty_tickets
    validate: /usr/sbin/visudo -cf %s
  become: true
  when: sudo_rs_check.rc == 0

- name: Authenticate sudo per tty session (traditional sudo only)
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    line: Defaults tty_tickets
    validate: /usr/sbin/visudo -cf %s
  become: true
  when: sudo_rs_check.rc != 0

- name: Install vim
  ansible.builtin.package:
    name: vim
    state: present
  become: true

- name: Set vim as the default editor for all users
  ansible.builtin.copy:
    src: default_editor.sh
    dest: /etc/profile.d/default_editor.sh
    owner: root
    group: root
    mode: "0644"
  become: true
