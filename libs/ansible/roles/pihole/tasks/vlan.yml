---
# VLAN Interface Configuration Tasks
# Creates VLAN 50 interface for macvlan networking

- name: Load 8021q kernel module
  community.general.modprobe:
    name: 8021q
    state: present
  become: true

- name: Ensure 8021q module loads on boot
  ansible.builtin.lineinfile:
    path: /etc/modules
    line: "8021q"
    state: present
    create: true
    mode: "0644"
  become: true

- name: Create VLAN interface configuration
  ansible.builtin.copy:
    content: |
      auto eth0.50
      iface eth0.50 inet manual
          vlan-raw-device eth0
    dest: /etc/network/interfaces.d/eth0.50
    mode: "0644"
  become: true
  register: vlan_config

- name: Bring up VLAN interface if not exists
  ansible.builtin.shell: |
    if ! ip link show eth0.50 2>/dev/null; then
      ip link add link eth0 name eth0.50 type vlan id 50
      ip link set eth0.50 up
    fi
  become: true
  changed_when: false
