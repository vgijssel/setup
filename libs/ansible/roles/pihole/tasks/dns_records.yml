---
# DNS Records Configuration Tasks
# Configures custom DNS records in Pi-hole v6 via pihole.toml

- name: Wait for VLAN 50 Pi-hole container to be ready
  ansible.builtin.wait_for:
    path: "{{ pihole_vlan50_data_dir }}/etc-pihole/pihole.toml"
    state: present
    timeout: 120
  become: true
  when: pihole_dns_records | length > 0

- name: Configure custom DNS records for VLAN 50 Pi-hole
  ansible.builtin.template:
    src: dns_records.toml.j2
    dest: "{{ pihole_vlan50_data_dir }}/etc-pihole/custom_dns.conf"
    mode: "0644"
  become: true
  notify: restart pihole-vlan50
  when: pihole_dns_records | length > 0

- name: Update pihole.toml hosts array for VLAN 50
  ansible.builtin.blockinfile:
    path: "{{ pihole_vlan50_data_dir }}/etc-pihole/pihole.toml"
    marker: "# {mark} ANSIBLE MANAGED DNS RECORDS"
    block: |
      # Custom DNS records managed by Ansible
      # These are loaded into the hosts array
    insertafter: EOF
  become: true
  when: pihole_dns_records | length > 0

- name: Generate hosts entries for VLAN 50 Pi-hole
  ansible.builtin.lineinfile:
    path: "{{ pihole_vlan50_data_dir }}/etc-pihole/custom.list"
    line: "{{ item.ip }} {{ item.domain }}"
    create: true
    mode: "0644"
  loop: "{{ pihole_dns_records }}"
  become: true
  notify: restart pihole-vlan50
  when: pihole_dns_records | length > 0

- name: Reload DNS in VLAN 50 Pi-hole
  community.docker.docker_container_exec:
    container: "{{ pihole_vlan50_container_name }}"
    command: pihole reloaddns
  become: true
  when: pihole_dns_records | length > 0
  changed_when: false
