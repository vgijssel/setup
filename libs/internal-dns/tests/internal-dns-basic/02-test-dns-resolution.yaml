apiVersion: kuttl.dev/v1beta1
kind: TestStep
metadata:
  name: test-dns-resolution
spec:
  commands:
    - command: |
        # Get the DNS service IP
        DNS_SERVICE_IP=$(kubectl get service internal-dns-test -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        echo "Using DNS Service IP: $DNS_SERVICE_IP"

        # Get the ingress controller IP
        INGRESS_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        echo "Expected Ingress Controller IP: $INGRESS_IP"

        if [ -z "$DNS_SERVICE_IP" ] || [ -z "$INGRESS_IP" ]; then
          echo "Failed to get required IPs"
          exit 1
        fi

        # Run nslookup against the DNS service
        kubectl run dns-validation --image=busybox:1.36 --rm -i --restart=Never -- sh -c "
        RESULT=\$(nslookup testing.enigma.vgijssel.nl $DNS_SERVICE_IP 2>/dev/null | grep 'Address:' | tail -1 | awk '{print \$2}')
        echo \"DNS resolution result: \$RESULT\"
        if [ \"\$RESULT\" != \"$INGRESS_IP\" ]; then
          echo \"DNS resolution failed: expected $INGRESS_IP, got \$RESULT\"
          exit 1
        fi
        echo \"DNS resolution successful: \$RESULT matches ingress controller IP\"
        "
      namespaced: true
