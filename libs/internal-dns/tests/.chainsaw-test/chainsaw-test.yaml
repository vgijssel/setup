apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: install-internal-dns
spec:
  description: Install and test internal-dns helm chart
  timeouts:
    apply: 2m
    assert: 5m
    exec: 15m
  bindings:
    - name: testHostname
      value: (join('.', [$namespace, 'enigma.vgijssel-dev.nl']))
  steps:
    - name: Install internal-dns chart
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($namespace)
            content: |
              helm upgrade --install internal-dns ../.. \
                --namespace "$NAMESPACE" \
                --create-namespace \
                --wait
        - assert:
            file: internal-dns-assert.yaml
      cleanup:
        - script:
            env:
              - name: NAMESPACE
                value: ($namespace)
            content: |
              # Make cleanup idempotent - don't fail if chart is already deleted
              if helm list -n "$NAMESPACE" | grep -q "internal-dns"; then
                helm uninstall internal-dns --namespace "$NAMESPACE" --wait || true
              fi
    - name: Verify OnePasswordItem created secret
      try:
        - assert:
            file: onepassword-secret-assert.yaml
            timeout: 3m
    - name: Create test ingress
      try:
        - apply:
            file: test-ingress.yaml
    - name: Verify external-dns is running
      try:
        - assert:
            file: external-dns-running-assert.yaml
    - name: Validate DNS record exists in Cloudflare
      try:
        - script:
            timeout: 3m
            env:
              - name: NAMESPACE
                value: ($namespace)
              - name: TEST_HOSTNAME
                value: ($testHostname)
            content: |
              # Validate DNS record was created in Cloudflare
              # Retry up to 12 times (2 minutes) to allow for DNS propagation

              for i in $(seq 1 12); do
                echo "Attempt $i: Checking DNS for $TEST_HOSTNAME"

                # Use nslookup to check if DNS record exists
                if nslookup "$TEST_HOSTNAME" 1.1.1.1 > /dev/null 2>&1; then
                  echo "SUCCESS: DNS record found for $TEST_HOSTNAME"
                  exit 0
                fi

                echo "DNS record not found yet, waiting 10 seconds..."
                sleep 10
              done

              echo "ERROR: DNS record not found for $TEST_HOSTNAME after 2 minutes"
              echo "External-dns logs:"
              kubectl logs -n $NAMESPACE -l app.kubernetes.io/name=internal-dns --tail=100 || true
              exit 1
    - name: Test cleanup hook on chart deletion
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($namespace)
            content: |
              echo "Uninstalling internal-dns chart to trigger cleanup hook..."
              # helm uninstall with --wait will wait for the pre-delete hook to complete
              helm uninstall internal-dns --namespace "$NAMESPACE" --wait
    - name: Verify cleanup job was auto-deleted
      try:
        - script:
            env:
              - name: NAMESPACE
                value: ($namespace)
            content: |
              echo "Verifying no cleanup jobs exist..."
              JOB_COUNT=$(kubectl get jobs -n "$NAMESPACE" -l app.kubernetes.io/name=internal-dns --no-headers 2>/dev/null | wc -l)
              if [ "$JOB_COUNT" != "0" ]; then
                echo "ERROR: Found $JOB_COUNT cleanup job(s), expected 0"
                kubectl get jobs -n "$NAMESPACE" -l app.kubernetes.io/name=internal-dns || true
                exit 1
              fi
              echo "SUCCESS: No cleanup jobs found (auto-deleted after completion)"
    - name: Verify DNS record has been removed from Cloudflare
      try:
        - script:
            timeout: 3m
            env:
              - name: TEST_HOSTNAME
                value: ($testHostname)
            content: |
              echo "Verifying DNS record has been removed from Cloudflare..."
              # Give DNS some time to propagate the deletion
              sleep 10

              # Check that DNS record no longer exists
              # Retry up to 12 times (2 minutes) to allow for DNS propagation
              for i in $(seq 1 12); do
                echo "Attempt $i: Checking DNS for $TEST_HOSTNAME"

                # Use nslookup - it should fail now
                if ! nslookup "$TEST_HOSTNAME" 1.1.1.1 > /dev/null 2>&1; then
                  echo "SUCCESS: DNS record has been removed for $TEST_HOSTNAME"
                  exit 0
                fi

                echo "DNS record still exists, waiting 10 seconds..."
                sleep 10
              done

              echo "ERROR: DNS record still exists for $TEST_HOSTNAME after 2 minutes"
              exit 1
