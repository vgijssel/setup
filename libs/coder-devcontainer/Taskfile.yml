version: "3"

vars:
  # Pre-fetch git info to avoid multiple gh API calls
  gh_pr_info:
    sh: gh pr view --json number,url,state,title,statusCheckRollup,baseRefName 2>/dev/null || echo '{}'

tasks:
  # Metadata fields: Tasks with 'meta' key are collected as workspace metadata
  # Meta key format: { include_in_list: boolean }
  # - include_in_list: true  → shown in list_agents (summary view)
  # - include_in_list: false → only shown in show_agent (detail view)

  pull_request_number:
    desc: The number of the current pull request on GitHub
    meta:
      include_in_list: true
    cmds:
      - echo '{{.gh_pr_info}}' | jq -r '.number // empty'

  pull_request_url:
    desc: The URL of the current pull request on GitHub
    meta:
      include_in_list: false
    cmds:
      - echo '{{.gh_pr_info}}' | jq -r '.url // empty'

  pull_request_state:
    desc: The state of the current pull request (OPEN, CLOSED, MERGED)
    meta:
      include_in_list: false
    cmds:
      - echo '{{.gh_pr_info}}' | jq -r '.state // empty'

  git_branch:
    desc: The name of the current git branch
    meta:
      include_in_list: false
    cmds:
      - git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown"

  pull_request_ci_status:
    desc: Whether all GitHub CI status checks passed (PASS, FAIL, PENDING, or empty if no PR)
    meta:
      include_in_list: false
    cmds:
      - |
        echo '{{.gh_pr_info}}' | jq -r '
          if .statusCheckRollup == null or (.statusCheckRollup | length) == 0 then
            empty
          elif all(.statusCheckRollup[]; .conclusion == "SUCCESS" or .conclusion == "SKIPPED" or .conclusion == "NEUTRAL") then
            "PASS"
          elif any(.statusCheckRollup[]; .status == "IN_PROGRESS" or .status == "QUEUED" or .status == "PENDING") then
            "PENDING"
          else
            "FAIL"
          end
        '

  pull_request_needs_update:
    desc: Whether the PR branch is behind the base branch and needs to be updated (true/false)
    meta:
      include_in_list: false
    cmds:
      - |
        BASE_BRANCH=$(echo '{{.gh_pr_info}}' | jq -r '.baseRefName // empty')
        if [ -z "$BASE_BRANCH" ]; then
          echo ""
        else
          # Fetch the latest state of the base branch
          git fetch origin "$BASE_BRANCH" 2>/dev/null || true
          # Count commits in base branch that aren't in current branch
          COMMITS_BEHIND=$(git rev-list --count HEAD..origin/"$BASE_BRANCH" 2>/dev/null || echo "0")
          if [ "$COMMITS_BEHIND" -gt 0 ]; then
            echo "true"
          else
            echo "false"
          fi
        fi
