apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: mutate-linstor-nodeselector
  labels:
    {{- include "internal-storage.labels" . | nindent 4 }}
  annotations:
    policies.kyverno.io/title: Add NodeSelector to LinstorCluster
    policies.kyverno.io/description: >-
      Mutates the LinstorCluster resource to add a nodeSelector that restricts
      linstor satellite pods to only run on nodes labeled with {{ .Values.nodeSelector.key }}={{ .Values.nodeSelector.value }}.
      This prevents linstor storage pods from scheduling on gateway nodes while still
      allowing metrics collection pods to run on all nodes.
spec:
  rules:
    - name: add-linstor-nodeselector
      match:
        any:
          - resources:
              kinds:
                - LinstorCluster
              names:
                - linstorcluster
              namespaces:
                - {{ .Values.linstorNamespace }}
      mutate:
        patchStrategicMerge:
          spec:
            nodeSelector:
              {{ .Values.nodeSelector.key }}: {{ .Values.nodeSelector.value }}
