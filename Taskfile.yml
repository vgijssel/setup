version: "3"

tasks:
  devenv:secrets:
    desc: Install secrets for the devenv
    cmds:
      - op inject --force --in-file=.op.env --out-file=.env
      - op read --force --out-file $HOME/.kube/provisioner-k8s.config "op://vgijssel-prod/provisioner-k8s-kubeconfig/certificate"
    sources:
      - .op.env

  devenv:install:
    desc: Install dependencies for the devenv
    dir: devenv
    env:
      PDM_IGNORE_ACTIVE_VENV: 1
    cmds:
      - pdm install
    sources:
      - pyproject.toml
      - pdm.lock

  devenv:provision:
    desc: Provision the devenv
    dir: devenv
    deps:
      - devenv:install
    cmds:
      - pdm run pyinfra inventory.py deploy.py -y {{.ARGS}}
    vars:
      DEFAULT_ARGS: --data install_editor=True
        --data install_terminal=True
        --data install_languages=True
        --data install_ssh=True
        --data install_utilities=True
        --data install_workflow=True
      ARGS: "{{default .DEFAULT_ARGS .CLI_ARGS}}"

  docs:serve:
    desc: Development server for the docs
    deps:
      - devenv:secrets
    cmds:
      - mkdocs serve -a localhost:8000

  provisioner:provision:
    desc: Provision the provisioner
    dir: ansible
    cmds:
      - ansible-playbook -i production provisioner.yml --diff {{.CLI_ARGS}}

  provisioner:provision:local:
    desc: Provision the provisioner using the local inventory
    dir: ansible
    cmds:
      - ansible-playbook -i production.local provisioner.yml --diff {{.CLI_ARGS}}

  provisioner-k8s:provision:
    desc: Provision the provisioner kubernetes cluster instance
    dir: ansible
    cmds:
      - ansible-playbook -i production provisioner-k8s.yml --diff {{.CLI_ARGS}}

  provisioner-k8s:provision:local:
    desc: Provision the provisioner kubernetes cluster instance using the local inventory
    dir: ansible
    cmds:
      - ansible-playbook -i production.local provisioner-k8s.yml --diff {{.CLI_ARGS}}

  pikvm:provision:
    desc: Provision the PiKVM
    dir: ansible
    cmds:
      - ansible-playbook -i production pikvm.yml --diff {{.CLI_ARGS}}

  pikvm:provision:local:
    desc: Provision the PiKVM using the local inventory
    dir: ansible
    cmds:
      - ansible-playbook -i production.local pikvm.yml --diff {{.CLI_ARGS}}

  tools:spacelift:build:
    desc: Build and push the Spacelift image
    dir: tools/spacelift
    cmds:
      - docker build --platform="linux/amd64" -t ghcr.io/vgijssel/setup/spacelift-runner-ansible:latest .
      - docker push ghcr.io/vgijssel/setup/spacelift-runner-ansible:latest

  incus-images:pikvm:prepare_disk:
    desc: Download and extract the PiKVM disk image
    dir: incus-images
    cmds:
      - packer build -only='prepare_disk.*' -on-error=ask .

  incus-images:pikvm:build:
    desc: Build an Incus container from the PiKVM disk image
    dir: incus-images
    cmds:
      - packer build -only='build_image.*' -on-error=ask .
