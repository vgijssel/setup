version: "3"

tasks:
  generate:
    desc: Generate the Talos configuration files
    cmds:
      - talosctl gen config --with-secrets secrets.yaml --config-patch-control-plane @the-toy-factory.patch.yaml --output-types controlplane -o the-toy-factory.yaml enigma https://192.168.1.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch-control-plane @the-dome.patch.yaml --output-types controlplane -o the-dome.yaml enigma https://192.168.1.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch-control-plane @illusion.patch.yaml --output-types controlplane -o illusion.yaml enigma https://192.168.1.50:6443 --force
    sources:
      - the-toy-factory.patch.yaml
      - the-dome.patch.yaml
      - illusion.patch.yaml
    generates:
      - the-toy-factory.yaml
      - the-dome.yaml
      - illusion.yaml

  init:
    desc: Apply initial configuration to nodes
    deps:
      - generate
    cmds:
      - talosctl apply-config --insecure -n {{.THE_TOY_FACTORY_IP}} --file the-toy-factory.yaml
      - talosctl apply-config --insecure -n {{.THE_DOME_IP}} --file the-dome.yaml
      - talosctl apply-config --insecure -n {{.ILLUSION_IP}} --file illusion.yaml
    requires:
      vars: [THE_TOY_FACTORY_IP, THE_DOME_IP, ILLUSION_IP]

  bootstrap:
    desc: Bootstrap the Talos cluster
    cmds:
      - talosctl bootstrap -n 192.168.1.40
      - talosctl health -n 192.168.1.40
