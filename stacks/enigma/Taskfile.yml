version: "3"

tasks:
  generate:cilium:
    desc: Generate the Cilium patch
    cmds:
      - pants run generate_cilium_patch.py
    sources:
      - "{{ .SERVICES_DIR }}/cilium/values.yaml"
      - generate_cilium_patch.py
    generates:
      - cilium.patch.yaml

  test:
    desc: Test Cilium connectivity tests
    cmds:
      - kubectl delete ns cilium-test-1 || true
      - kubectl create ns cilium-test-1
      - kubectl label ns cilium-test-1 pod-security.kubernetes.io/enforce=privileged
      - cilium connectivity test --test echo-ingress-l7 --pause-on-fail

  # hubble:test:
  #   desc: Validate status of Huble
  #   cmds:
  #     - cilium hubble port-forward --port-forward 4245
  #     - hubble status

  reboot:
    desc: Reboot Talos nodes
    cmds:
      - talosctl reboot -n 192.168.1.40,192.168.1.41,192.168.1.42

  generate:
    desc: Generate the Talos configuration files
    deps:
      - generate:cilium
    cmds:
      - talosctl gen config --with-secrets secrets.yaml --config-patch @cilium.patch.yaml --config-patch @all.patch.yaml --config-patch @the-toy-factory.patch.yaml --output-types controlplane -o the-toy-factory.yaml enigma https://192.168.1.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @cilium.patch.yaml --config-patch @all.patch.yaml --config-patch @the-dome.patch.yaml --output-types controlplane -o the-dome.yaml enigma https://192.168.1.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @cilium.patch.yaml --config-patch @all.patch.yaml --config-patch @illusion.patch.yaml --output-types controlplane -o illusion.yaml enigma https://192.168.1.50:6443 --force
    sources:
      - cilium.patch.yaml
      - all.patch.yaml
      - the-toy-factory.patch.yaml
      - the-dome.patch.yaml
      - illusion.patch.yaml
    generates:
      - the-toy-factory.yaml
      - the-dome.yaml
      - illusion.yaml

  bootstrap:
    desc: Apply initial configuration to nodes
    deps:
      - generate
    cmds:
      - talosctl apply-config --insecure -n {{.THE_TOY_FACTORY_IP}} --file the-toy-factory.yaml
      - talosctl apply-config --insecure -n {{.THE_DOME_IP}} --file the-dome.yaml
      - talosctl apply-config --insecure -n {{.ILLUSION_IP}} --file illusion.yaml
      - talosctl bootstrap -n 192.168.1.40
      - talosctl health -n 192.168.1.40
      - talosctl version
      # Write out the kubeconfig to a location known by kubie
      - talosctl kubeconfig -n 192.168.1.40 ~/.kube/configs/enigma.yaml
      - kubectl get nodes
    requires:
      vars: [THE_TOY_FACTORY_IP, THE_DOME_IP, ILLUSION_IP]

  apply:
    desc: Apply the configuration to the nodes
    deps:
      - generate
    cmds:
      - talosctl apply-config -n 192.168.1.40 --file the-toy-factory.yaml
      - talosctl apply-config -n 192.168.1.41 --file the-dome.yaml
      - talosctl apply-config -n 192.168.1.42 --file illusion.yaml
      # Necessary to pick up cilium changes
      - talosctl upgrade-k8s -n 192.168.1.40
      - kubectl rollout restart ds cilium -n kube-system
