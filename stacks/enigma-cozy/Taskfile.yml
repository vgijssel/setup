version: "3"

tasks:
  debug:
    # TODO: Use "node-shell" kubectl extension!
    #desc: Run a debug pod with elevated privileges
    #interactive: true
    #cmds:
    #- kubectl -n kube-system debug node/the-toy-factory --image ubuntu --profile sysadmin -it
    #preconditions:
    #- sh: kubie info ctx
    #msg: Make sure to be in a kubie shell

  reset:
    prompt: This will wipe the cluster and reset Talos nodes. Are you sure?
    desc: Reset the cluster to start a fresh Talos install
    cmds:
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.42 -e 192.168.1.42 --reboot --graceful=false --wait=false
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.41 -e 192.168.1.41 --reboot --graceful=false --wait=false
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.40 -e 192.168.1.40 --reboot --graceful=false --wait=false

  apply:bootstrap:
    deps: [generate:bootstrap]
    desc: Apply the Talos configuration to bootstrap the cluster
    cmds:
      - talosctl apply-config --insecure -n 192.168.1.42 -e 192.168.1.42 --file dist/illusion.yaml
      - talosctl apply-config --insecure -n 192.168.1.41 -e 192.168.1.41 --file dist/the-dome.yaml
      - talosctl apply-config --insecure -n 192.168.1.40 -e 192.168.1.40 --file dist/the-toy-factory.yaml
      - talosctl apply-config --insecure -n 46.224.93.115 -e 46.224.93.115 --file dist/here-i-am.yaml
      - wait-for-it --service 192.168.50.10:50000
      - wait-for-it --service 192.168.50.11:50000
      - wait-for-it --service 192.168.50.12:50000
      - wait-for-it --service 46.224.93.115:50000
      - talosctl bootstrap -n 192.168.50.10 -e 192.168.50.10
      - talosctl kubeconfig --force -n 192.168.50.50 kubeconfig.admin

  apply:
    deps: [generate]
    desc: Apply the Talos configuration to the cluster
    cmds:
      - talosctl apply-config -n 192.168.50.10 -e 192.168.50.10 --file dist/illusion.yaml
      - talosctl apply-config -n 192.168.50.11 -e 192.168.50.11 --file dist/the-dome.yaml
      - talosctl apply-config -n 192.168.50.12 -e 192.168.50.12 --file dist/the-toy-factory.yaml
      - talosctl apply-config -n 46.224.93.115 -e 46.224.93.115 --file dist/here-i-am.yaml

  reboot:
    desc: Reboot Talos nodes
    cmds:
      - talosctl reboot -n 192.168.50.10,192.168.50.11,192.168.50.12

  upgrade:talos:
    desc: Upgrade Talos OS images on cluster nodes (rolling upgrade)
    cmds:
      - ./scripts/upgrade-talos.sh {{.CLI_ARGS}}

  generate:bootstrap:
    desc: Generate the Talos configuration files for bootstrapping
    cmds:
      - mkdir -p dist
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @illusion.patch.yaml --output-types controlplane -o dist/illusion.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @the-dome.patch.yaml --output-types controlplane -o dist/the-dome.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @the-toy-factory.patch.yaml --output-types controlplane -o dist/the-toy-factory.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @here-i-am.patch.yaml --output-types worker -o dist/here-i-am.yaml enigma-cozy https://192.168.50.50:6443 --force
    sources:
      - all.patch.yaml
      - illusion.patch.yaml
      - the-dome.patch.yaml
      - the-toy-factory.patch.yaml
      - here-i-am.patch.yaml
    generates:
      - dist/illusion.yaml
      - dist/the-dome.yaml
      - dist/the-toy-factory.yaml
      - dist/here-i-am.yaml

  generate:
    desc: Generate the Talos configuration files
    cmds:
      - mkdir -p dist
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @illusion.patch.yaml --output-types controlplane -o dist/illusion.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @the-dome.patch.yaml --output-types controlplane -o dist/the-dome.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @the-toy-factory.patch.yaml --output-types controlplane -o dist/the-toy-factory.yaml enigma-cozy https://192.168.50.50:6443 --force
      - talosctl gen config --with-secrets secrets.yaml --config-patch @all.patch.yaml --config-patch @here-i-am.patch.yaml --output-types worker -o dist/here-i-am.yaml enigma-cozy https://192.168.50.50:6443 --force
    sources:
      - all.patch.yaml
      - illusion.patch.yaml
      - the-dome.patch.yaml
      - the-toy-factory.patch.yaml
      - here-i-am.patch.yaml
    generates:
      - dist/illusion.yaml
      - dist/the-dome.yaml
      - dist/the-toy-factory.yaml
      - dist/here-i-am.yaml
