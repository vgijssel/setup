version: "3"

tasks:
  debug:
    # TODO: Use "node-shell" kubectl extension!
    #desc: Run a debug pod with elevated privileges
    #interactive: true
    #cmds:
    #- kubectl -n kube-system debug node/the-toy-factory --image ubuntu --profile sysadmin -it
    #preconditions:
    #- sh: kubie info ctx
    #msg: Make sure to be in a kubie shell

  reset:
    prompt: This will wipe the cluster and reset Talos nodes. Are you sure?
    desc: Reset the cluster to start a fresh Talos install
    cmds:
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.42 -e 192.168.1.42 --reboot --graceful=false --wait=false
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.41 -e 192.168.1.41 --reboot --graceful=false --wait=false
      - talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.40 -e 192.168.1.40 --reboot --graceful=false --wait=false

  apply:bootstrap:
    deps: [generate:bootstrap]
    desc: Apply the Talos configuration to bootstrap the cluster
    cmds:
      - talm apply -f nodes/illusion.yaml --insecure
      - talm apply -f nodes/the-dome.yaml --insecure
      - talm apply -f nodes/the-toy-factory.yaml --insecure
      - wait-for-it --service 192.168.50.10:50000
      - wait-for-it --service 192.168.50.11:50000
      - wait-for-it --service 192.168.50.12:50000
      - talm bootstrap -f nodes/illusion.yaml
      - talm kubeconfig ~/.kube/configs/enigma.yaml --force -f nodes/illusion.yaml

  apply:
    deps: [generate]
    desc: Apply the Talos configuration to the cluster
    cmds:
      - talm apply -f nodes/illusion.yaml
      - talm apply -f nodes/the-dome.yaml
      - talm apply -f nodes/the-toy-factory.yaml

  reboot:
    desc: Reboot Talos nodes
    cmds:
      - talm reboot --mode powercycle -f nodes/illusion.yaml -f nodes/the-dome.yaml -f nodes/the-toy-factory.yaml

  #   validate:
  #     desc: Validate Cluster Health
  #     cmds:
  #       - goss validate

  #shutdown:
  #desc: Shutdown Talos nodes
  #cmds:
  #- talosctl shutdown -n 192.168.1.40,192.168.1.41,192.168.1.42

  generate:bootstrap:
    desc: Generate the Talos configuration files for bootstrapping
    cmds:
      - talm template -e 192.168.1.42 -n 192.168.1.42 -t templates/controlplane.yaml --set nodeName=illusion --insecure > nodes/illusion.yaml
      - talm template -e 192.168.1.41 -n 192.168.1.41 -t templates/controlplane.yaml --set nodeName=the-dome --insecure > nodes/the-dome.yaml
      - talm template -e 192.168.1.40 -n 192.168.1.40 -t templates/controlplane.yaml --set nodeName=the-toy-factory --insecure > nodes/the-toy-factory.yaml

  generate:
    desc: Generate the Talos configuration files
    cmds:
      - talm template -e 192.168.50.10 -n 192.168.50.10 -t templates/controlplane.yaml --set nodeName=illusion > nodes/illusion.yaml
      - talm template -e 192.168.50.11 -n 192.168.50.11 -t templates/controlplane.yaml --set nodeName=the-dome > nodes/the-dome.yaml
      - talm template -e 192.168.50.12 -n 192.168.50.12 -t templates/controlplane.yaml --set nodeName=the-toy-factory > nodes/the-toy-factory.yaml
