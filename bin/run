#!/bin/bash
# Note: This script was previously named bin/exec but was renamed to bin/run
# because "exec" in binstub scripts was being interpreted as this script instead
# of the shell's "exec" builtin, causing a recursive loop.
#
# CAUTION: bin/run can still recurse if:
# 1. A binstub (e.g., bin/claude) calls: bin/run moon run <project>:start
# 2. The moon task uses "pnpm exec <cmd>" which falls back to PATH
# 3. PATH includes bin/ (from Hermit), finding bin/<cmd> instead of node_modules/.bin/<cmd>
# 4. The binstub calls bin/run again â†’ infinite loop
#
# Fix: Moon tasks should use explicit paths (./node_modules/.bin/<cmd>) not pnpm exec.

set -eo pipefail

# Get the repository root directory
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Path to the internal direnv binary
DIRENV_BIN="${REPO_ROOT}/bin/direnv"

# Safety: prevent deep recursion (can happen if pnpm exec falls back to bin/ binstubs)
export BIN_RUN_DEPTH="${BIN_RUN_DEPTH:-0}"
BIN_RUN_DEPTH=$((BIN_RUN_DEPTH + 1))
export BIN_RUN_DEPTH

if [[ "${BIN_RUN_DEPTH}" -gt 3 ]]; then
    echo "[bin/run] ERROR: Recursion detected (depth=${BIN_RUN_DEPTH}). This usually means a moon task" >&2
    echo "[bin/run] is using 'pnpm exec <cmd>' which falls back to bin/<cmd> instead of node_modules/.bin/<cmd>." >&2
    echo "[bin/run] Fix: Use './node_modules/.bin/<cmd>' instead of 'pnpm exec <cmd>' in moon.yml." >&2
    echo "[bin/run] The current path: ${PATH}" >&2
    exit 1
fi

# Check if .envrc is allowed (status shows "Found RC allowed 0" when allowed)
if ! DIRENV_LOG_FORMAT="" "${DIRENV_BIN}" status 2>/dev/null | grep -q "Found RC allowed 0"; then
    DIRENV_LOG_FORMAT="" "${DIRENV_BIN}" allow "${REPO_ROOT}" >/dev/null 2>&1
fi

# Execute the command with direnv exec, passing all arguments
DIRENV_LOG_FORMAT="" exec "${DIRENV_BIN}" exec "${REPO_ROOT}" "$@"
