#!/bin/bash
# Note: This script was previously named bin/exec but was renamed to bin/run
# because "exec" in binstub scripts was being interpreted as this script instead
# of the shell's "exec" builtin, causing a recursive loop.

set -eo pipefail

# Get the repository root directory
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Path to the internal direnv binary
DIRENV_BIN="${REPO_ROOT}/bin/direnv"

# Debug: Track recursion depth
export BIN_RUN_DEPTH="${BIN_RUN_DEPTH:-0}"
BIN_RUN_DEPTH=$((BIN_RUN_DEPTH + 1))
export BIN_RUN_DEPTH

echo "[bin/run] ========================================" >&2
echo "[bin/run] Depth: ${BIN_RUN_DEPTH}" >&2
echo "[bin/run] Args: $@" >&2
echo "[bin/run] \$0: $0" >&2
echo "[bin/run] BASH_SOURCE: ${BASH_SOURCE[*]}" >&2
echo "[bin/run] Caller: $(caller 0 2>/dev/null || echo 'N/A')" >&2
echo "[bin/run] Parent PID: $PPID ($(ps -o comm= -p $PPID 2>/dev/null || echo 'unknown'))" >&2
echo "[bin/run] PATH first 3: $(echo "$PATH" | tr ':' '\n' | head -3 | tr '\n' ':')" >&2

# Safety: prevent deep recursion
if [ "${BIN_RUN_DEPTH}" -gt 5 ]; then
    echo "[bin/run] ERROR: Recursion depth exceeded (${BIN_RUN_DEPTH}). Aborting." >&2
    exit 1
fi

# Check if .envrc is allowed (status shows "Found RC allowed 0" when allowed)
if ! DIRENV_LOG_FORMAT="" "${DIRENV_BIN}" status 2>/dev/null | grep -q "Found RC allowed 0"; then
    DIRENV_LOG_FORMAT="" "${DIRENV_BIN}" allow "${REPO_ROOT}" >/dev/null 2>&1
fi

# Execute the command with direnv exec, passing all arguments
echo "[bin/run] Executing: ${DIRENV_BIN} exec ${REPO_ROOT} $@" >&2
echo "[bin/run] ========================================" >&2
DIRENV_LOG_FORMAT="" exec "${DIRENV_BIN}" exec "${REPO_ROOT}" "$@"
