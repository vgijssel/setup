#!/usr/bin/env bash
set -e

# devcontainer-install-extensions - Install VSCode extensions from devcontainer.json
#
# Usage: devcontainer-install-extensions --file <path-to-devcontainer.json>
#
# This script reads a devcontainer.json file and installs all VSCode extensions
# specified in customizations.vscode.extensions using the VSCode CLI.

# Parse command line arguments
DEVCONTAINER_FILE=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --file)
      DEVCONTAINER_FILE="$2"
      shift 2
      ;;
    *)
      echo "Error: Unknown option $1" >&2
      echo "Usage: devcontainer-install-extensions --file <path-to-devcontainer.json>" >&2
      exit 1
      ;;
  esac
done

# Validate arguments
if [ -z "$DEVCONTAINER_FILE" ]; then
  echo "Error: --file argument is required" >&2
  echo "Usage: devcontainer-install-extensions --file <path-to-devcontainer.json>" >&2
  exit 1
fi

if [ ! -f "$DEVCONTAINER_FILE" ]; then
  echo "Error: File not found: $DEVCONTAINER_FILE" >&2
  exit 1
fi

echo "Installing VSCode extensions from $DEVCONTAINER_FILE..."

# Extract extensions list using jq
EXTENSIONS=$(jq -r '.customizations.vscode.extensions[]?' "$DEVCONTAINER_FILE" 2>/dev/null || true)

if [ -z "$EXTENSIONS" ]; then
  echo "No extensions found in $DEVCONTAINER_FILE"
  exit 0
fi

EXTENSION_COUNT=$(echo "$EXTENSIONS" | wc -l | tr -d ' ')
echo "Found $EXTENSION_COUNT extensions to install"

# Ensure code CLI is available
if ! command -v code >/dev/null 2>&1; then
  echo "Error: VSCode CLI 'code' not found in PATH" >&2
  echo "Please ensure the vscode-cli tool is installed via Hermit" >&2
  exit 1
fi

# Create extensions directory
mkdir -p ~/.vscode-server/extensions

# Install each extension
echo "$EXTENSIONS" | while read -r extension; do
  if [ -n "$extension" ]; then
    echo "Installing extension: $extension"
    if code --extensions-dir ~/.vscode-server/extensions --install-extension "$extension"; then
      echo "✓ Successfully installed $extension"
    else
      echo "⚠ Warning: Failed to install $extension" >&2
    fi
  fi
done

echo "VSCode extension installation complete"
