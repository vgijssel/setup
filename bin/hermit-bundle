#!/bin/bash
# hermit-bundle - Create a hermit bundle tarball in a target directory
#
# This script works around filesystem symlink issues on macOS virtiofs mounts
# by creating the bundle in a temporary directory and outputting a tarball.
#
# Usage: hermit-bundle <target-dir> <package1> [package2] ...
#
# Output: Creates <target-dir>/hermit-bundle.tar.gz

set -e

if [ $# -lt 2 ]; then
    echo "Usage: hermit-bundle <target-dir> <package1> [package2] ..." >&2
    exit 1
fi

TARGET_DIR="$1"
shift
PACKAGES="$@"

TEMP_BUNDLE_DIR=$(mktemp -d)

echo "Creating hermit bundle in temporary directory: ${TEMP_BUNDLE_DIR}"

# Ensure temp directory has the required structure for hermit
mkdir -p "${TEMP_BUNDLE_DIR}/third_party"

# Run hermit bundle to create the bundle in temp directory
hermit bundle "${TEMP_BUNDLE_DIR}" ${PACKAGES}

# Create the target directory
mkdir -p "${TARGET_DIR}"

# Create a tarball of the bundle
echo "Creating tarball at ${TARGET_DIR}/hermit-bundle.tar.gz"
tar -czf "${TARGET_DIR}/hermit-bundle.tar.gz" -C "${TEMP_BUNDLE_DIR}" .

# Cleanup temp directory
rm -rf "${TEMP_BUNDLE_DIR}"

echo "Successfully created hermit bundle tarball"
