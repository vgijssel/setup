#!/usr/bin/env bash
set -e

# Colors for better readability
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MOON="${SCRIPT_DIR}/moon"

echo -e "${GREEN}=== Moon Monorepo Help ===${NC}"
echo ""

# Display all projects
echo -e "${BLUE}Available Projects:${NC}"
PROJECTS=$("${MOON}" query projects --json 2>/dev/null | jq -r '.projects[].id' | sort)
if [[ -n "${PROJECTS}" ]]; then
    while IFS= read -r project; do
        echo "  - ${project}"
    done <<< "${PROJECTS}"
else
    echo "  No projects found"
fi
echo ""

# Display targets by project (first 5 projects to avoid overwhelming output)
echo -e "${BLUE}Available Tasks by Project (first 5):${NC}"

"${MOON}" query projects --json 2>/dev/null | jq -r '.projects[].id' | sort | head -5 | while IFS= read -r project_name; do
    printf "  %b%s:%b\n" "${CYAN}" "${project_name}" "${NC}"
    "${MOON}" query tasks --json 2>/dev/null | jq -r --arg proj "${project_name}" '.tasks[$proj] // {} | keys[]' 2>/dev/null | head -5 | while read -r task; do
        echo "    - ${task}"
    done
    echo ""
done

# Show common workspace commands
echo -e "${BLUE}Common Workspace Commands:${NC}"
echo -e "${YELLOW}Project Commands:${NC}"
echo "  - moon run <project>:<task>  - Run a specific task for a project"
echo "  - moon project <name>        - Show detailed information about a project"
echo "  - moon task <project>:<task> - Show detailed information about a task"
echo ""

echo -e "${YELLOW}Multi-Project Commands:${NC}"
echo "  - moon run :<task>           - Run a task across all projects"
echo "  - moon run :<task> --affected - Run task only on affected projects"
echo "  - moon check                 - Run build/test/lint on current project"
echo "  - moon check --all           - Run build/test/lint on all projects"
echo ""

echo -e "${YELLOW}Workspace Management:${NC}"
echo "  - moon query projects        - List all projects in the workspace"
echo "  - moon query tasks           - List all tasks in the workspace"
echo "  - moon project-graph         - Open interactive project dependency graph"
echo "  - moon task-graph            - Open interactive task dependency graph"
echo "  - moon clean                 - Clear moon cache"
echo ""

echo -e "${YELLOW}CI/CD Commands:${NC}"
echo "  - moon ci <base> <head>      - Run tasks affected between commits"
echo "  - moon ci --affected         - Run affected tasks in CI mode"
echo ""

echo -e "${YELLOW}Code Quality:${NC}"
echo "  - trunk fmt                  - Format code using Trunk"
echo "  - trunk check                - Run all linters and checks"
echo ""

# Show tips
echo -e "${GREEN}Tips:${NC}"
echo "  - Use '--log debug' for detailed output"
echo "  - Use '--help' with any moon command for detailed options"
echo "  - Caching is automatic - repeated runs are instant"
echo "  - Use '--force' to bypass cache and re-run tasks"
echo ""

# Dynamic examples based on actual projects
echo -e "${GREEN}Examples:${NC}"
if [[ -n "${PROJECTS}" ]]; then
    # Get first few projects for examples
    first_project=$(echo "${PROJECTS}" | head -1) || true
    second_project=$(echo "${PROJECTS}" | head -2 | tail -1) || true

    if [[ -n "${first_project}" ]]; then
        echo "  - moon project ${first_project}"
        echo "  - moon run ${first_project}:build"
        echo "  - moon run ${first_project}:test"
    fi

    if [[ -n "${second_project}" && "${second_project}" != "${first_project}" ]]; then
        echo "  - moon project ${second_project}"
    fi
else
    echo "  - moon query projects"
fi

echo "  - moon ci origin/main HEAD"
echo "  - moon run :build --affected"
echo "  - moon check --all"
