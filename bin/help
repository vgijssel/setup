#!/usr/bin/env bash
set -e

# Colors for better readability
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Nx Monorepo Help ===${NC}"
echo ""

# Build the help data using nx-help library (with TUI disabled)
NX_RUNNER_TUI=false nx run nx-help:build > /dev/null 2>&1 || {
    echo "Error: Failed to generate help data"
    exit 1
}

# Load the generated JSON
HELP_DATA=$(cat libs/nx-help/dist/projects.json)

# Display all projects
echo -e "${BLUE}Available Projects:${NC}"
PROJECTS=$(echo "${HELP_DATA}" | jq -r '.projects[].name' | sort)
if [[ -n "${PROJECTS}" ]]; then
    while IFS= read -r project; do
        echo "  • ${project}"
    done <<< "${PROJECTS}"
else
    echo "  No projects found"
fi
echo ""

# Display targets by project
echo -e "${BLUE}Available Targets by Project:${NC}"

echo "${HELP_DATA}" | jq -c '.projects[]' | while IFS= read -r project_data; do
    project_name=$(echo "${project_data}" | jq -r '.name')
    printf "  %b%s:%b\n" "${CYAN}" "${project_name}" "${NC}"

    echo "${project_data}" | jq -r '.targets[] | "    • \(.name)" + (if .description != "" then " - \(.description)" else "" end)'
    echo ""
done

# Show common workspace commands
echo -e "${BLUE}Common Workspace Commands:${NC}"
echo -e "${YELLOW}Project Commands:${NC}"
echo "  • nx run <project>:<target>  - Run a specific target for a project"
echo "  • nx show project <name>     - Show detailed information about a project"
echo ""

echo -e "${YELLOW}Multi-Project Commands:${NC}"
echo "  • nx run-many -t <target>    - Run a target across multiple projects"
echo "  • nx affected:<target>       - Run target only on affected projects"
echo "  • nx affected:graph          - Show dependency graph of affected projects"
echo ""

echo -e "${YELLOW}Workspace Management:${NC}"
echo "  • nx show projects           - List all projects in the workspace"
echo "  • nx graph                   - Open interactive project dependency graph"
echo "  • nx list                    - List installed Nx plugins"
echo "  • nx release                 - Create releases with GitHub artifacts"
echo "  • nx reset                   - Clear Nx cache and reset workspace"
echo ""

echo -e "${YELLOW}Code Quality:${NC}"
echo "  • nx format:write            - Format all code in the workspace"
echo "  • nx format:check            - Check code formatting"
echo "  • trunk fmt                  - Format code using Trunk"
echo "  • trunk check                - Run all linters and checks"
echo ""

# Show tips
echo -e "${GREEN}Tips:${NC}"
echo "  • Use tab completion with nx commands when available"
echo "  • Add '--dry-run' to see what would be executed without running it"
echo "  • Use '--verbose' for detailed output"
echo "  • Use '--help' with any nx command for detailed options"
echo ""

# Dynamic examples based on actual projects
echo -e "${GREEN}Examples:${NC}"
if [[ -n "${PROJECTS}" ]]; then
    # Get first few projects for examples
    first_project=$(echo "${PROJECTS}" | head -1) || true
    second_project=$(echo "${PROJECTS}" | head -2 | tail -1) || true

    if [[ -n "${first_project}" ]]; then
        echo "  • nx show project ${first_project}"
        first_targets=$(echo "${HELP_DATA}" | jq -r --arg proj "${first_project}" '.projects[] | select(.name == $proj) | .targets[].name' | head -2) || true
        if [[ -n "${first_targets}" ]]; then
            echo "${first_targets}" | while read -r target; do
                [[ -n "${target}" ]] && echo "  • nx run ${first_project}:${target}"
            done
        fi
    fi

    if [[ -n "${second_project}" && "${second_project}" != "${first_project}" ]]; then
        echo "  • nx show project ${second_project}"
    fi
else
    echo "  • nx show projects"
fi

echo "  • nx affected:test --base=main"
echo "  • nx run-many -t build --parallel"