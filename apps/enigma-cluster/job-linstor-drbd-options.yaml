---
apiVersion: v1
kind: ConfigMap
metadata:
  name: linstor-drbd-options-script
  namespace: cozy-linstor
data:
  configure-drbd-options.sh: |
    #!/bin/sh
    set -e

    echo "Configuring LINSTOR controller DRBD options for 25Gbps network..."

    # Set controller-level DRBD options for all resources
    # These apply to new connections and can be overridden per-resource
    # Reference: https://cozystack.io/docs/storage/drbd-tuning/

    # PeerDevice options for resync tuning
    # c-max-rate: 2 GB/s (~80% of 25Gbps, NVMe becomes bottleneck at 2.4 GB/s)
    linstor controller drbd-options --peer-device-options --c-max-rate 2048000 || echo "c-max-rate already set or not supported"
    # c-min-rate: 680 MB/s (1/3 of c-max-rate per LINBIT recommendation)
    linstor controller drbd-options --peer-device-options --c-min-rate 696320 || echo "c-min-rate already set or not supported"
    # resync-rate: starting point for dynamic controller
    linstor controller drbd-options --peer-device-options --resync-rate 696320 || echo "resync-rate already set or not supported"
    # c-plan-ahead: 2 seconds lookahead for larger bursts
    linstor controller drbd-options --peer-device-options --c-plan-ahead 20 || echo "c-plan-ahead already set or not supported"
    # c-fill-target: ~20 MiB buffer fill target
    linstor controller drbd-options --peer-device-options --c-fill-target 20480 || echo "c-fill-target already set or not supported"

    # Network buffer tuning for 25Gbps throughput
    linstor controller drbd-options --net-options --max-buffers 65536 || echo "max-buffers already set or not supported"
    linstor controller drbd-options --net-options --sndbuf-size 33554432 || echo "sndbuf-size already set or not supported"
    linstor controller drbd-options --net-options --rcvbuf-size 33554432 || echo "rcvbuf-size already set or not supported"

    echo "DRBD options configured. Verifying..."
    linstor controller drbd-options

    echo "Done."
---
apiVersion: batch/v1
kind: Job
metadata:
  name: linstor-configure-drbd-options
  namespace: cozy-linstor
  annotations:
    # Re-run job when script changes
    checksum/script: "v1"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: linstor-controller
      restartPolicy: OnFailure
      containers:
        - name: linstor-client
          image: quay.io/piraeusdatastore/piraeus-server:v1.27.1
          command: ["/bin/sh", "/scripts/configure-drbd-options.sh"]
          env:
            - name: LS_CONTROLLERS
              value: http://linstor-controller.cozy-linstor.svc:3370
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: linstor-drbd-options-script
            defaultMode: 0755
