---
apiVersion: v1
kind: ConfigMap
metadata:
  name: linstor-drbd-options-script
  namespace: cozy-linstor
data:
  configure-drbd-options.sh: |
    #!/bin/sh
    set -e

    echo "Configuring LINSTOR controller DRBD options for 25Gbps network..."

    # Set controller-level DRBD options for all resources
    # These apply to new connections and can be overridden per-resource
    # Reference: https://cozystack.io/docs/storage/drbd-tuning/

    # All options in single command
    # - c-max-rate: 2 GB/s (~80% of 25Gbps, NVMe becomes bottleneck at 2.4 GB/s)
    # - c-min-rate: 680 MB/s (1/3 of c-max-rate per LINBIT recommendation)
    # - resync-rate: starting point for dynamic controller
    # - c-plan-ahead: 2 seconds lookahead for larger bursts (in 1/10 seconds)
    # - c-fill-target: ~20 MiB buffer fill target (in sectors)
    # - max-buffers: number of buffers for 25Gbps
    # - sndbuf-size/rcvbuf-size: 32MB buffers for high throughput

    linstor controller drbd-options \
      --c-max-rate 2048000 \
      --c-min-rate 696320 \
      --resync-rate 696320 \
      --c-plan-ahead 20 \
      --c-fill-target 20480 \
      --max-buffers 65536 \
      --sndbuf-size 33554432 \
      --rcvbuf-size 33554432

    echo "DRBD options configured. Verifying..."
    linstor controller drbd-options

    echo "Done."
---
apiVersion: batch/v1
kind: Job
metadata:
  name: linstor-configure-drbd-options
  namespace: cozy-linstor
  annotations:
    # Re-run job when script changes
    checksum/script: "v2"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: linstor-controller
      restartPolicy: OnFailure
      containers:
        - name: linstor-client
          image: quay.io/piraeusdatastore/piraeus-server:v1.27.1
          command: ["/bin/sh", "/scripts/configure-drbd-options.sh"]
          env:
            - name: LS_CONTROLLERS
              value: http://linstor-controller.cozy-linstor.svc:3370
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: linstor-drbd-options-script
            defaultMode: 0755
