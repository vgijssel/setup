---
# RBAC for LINSTOR storage network configuration job
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: linstor-storage-network-config
  namespace: cozy-linstor
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: linstor-storage-network-config
  namespace: cozy-linstor
subjects:
  - kind: ServiceAccount
    name: linstor-controller
    namespace: cozy-linstor
roleRef:
  kind: Role
  name: linstor-storage-network-config
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: linstor-storage-network
  namespace: cozy-linstor
  labels:
    app: linstor-storage-network
  annotations:
    config-version: "v7"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: linstor-storage-network
    spec:
      serviceAccountName: linstor-controller
      restartPolicy: OnFailure
      containers:
        - name: configure
          image: bitnami/kubectl:latest
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            seccompProfile:
              type: RuntimeDefault
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              echo "========================================"
              echo "LINSTOR Storage Network Configuration"
              echo "========================================"

              # Helper function to run linstor commands
              linstor_exec() {
                kubectl exec -n cozy-linstor deployment/linstor-controller -- linstor "$@"
              }

              # Helper to check if interface exists
              interface_exists() {
                kubectl exec -n cozy-linstor deployment/linstor-controller -- linstor node interface list "$1" 2>/dev/null | grep -q "$2"
              }

              # Helper to check if path exists
              path_exists() {
                kubectl exec -n cozy-linstor deployment/linstor-controller -- linstor node-connection path list "$1" "$2" 2>/dev/null | grep -q "$3"
              }

              echo ""
              echo "=== Step 1: Creating Node Interfaces ==="

              # illusion interfaces
              echo "Configuring illusion..."
              if interface_exists illusion storage-dome; then
                echo "  [OK] storage-dome already exists"
              else
                echo "  [CREATE] storage-dome with IP 10.50.1.0"
                linstor_exec node interface create illusion storage-dome 10.50.1.0
              fi
              if interface_exists illusion storage-toyfactory; then
                echo "  [OK] storage-toyfactory already exists"
              else
                echo "  [CREATE] storage-toyfactory with IP 10.50.2.1"
                linstor_exec node interface create illusion storage-toyfactory 10.50.2.1
              fi

              # the-dome interfaces
              echo "Configuring the-dome..."
              if interface_exists the-dome storage-illusion; then
                echo "  [OK] storage-illusion already exists"
              else
                echo "  [CREATE] storage-illusion with IP 10.50.1.1"
                linstor_exec node interface create the-dome storage-illusion 10.50.1.1
              fi
              if interface_exists the-dome storage-toyfactory; then
                echo "  [OK] storage-toyfactory already exists"
              else
                echo "  [CREATE] storage-toyfactory with IP 10.50.3.0"
                linstor_exec node interface create the-dome storage-toyfactory 10.50.3.0
              fi

              # the-toy-factory interfaces
              echo "Configuring the-toy-factory..."
              if interface_exists the-toy-factory storage-illusion; then
                echo "  [OK] storage-illusion already exists"
              else
                echo "  [CREATE] storage-illusion with IP 10.50.2.0"
                linstor_exec node interface create the-toy-factory storage-illusion 10.50.2.0
              fi
              if interface_exists the-toy-factory storage-dome; then
                echo "  [OK] storage-dome already exists"
              else
                echo "  [CREATE] storage-dome with IP 10.50.3.1"
                linstor_exec node interface create the-toy-factory storage-dome 10.50.3.1
              fi

              echo ""
              echo "=== Step 2: Creating Node-Connection Paths ==="

              # illusion <-> the-dome
              echo "Configuring illusion <-> the-dome..."
              if path_exists illusion the-dome direct; then
                echo "  [OK] path 'direct' already exists"
              else
                echo "  [CREATE] path 'direct' via storage-dome <-> storage-illusion"
                linstor_exec node-connection path create illusion the-dome direct storage-dome storage-illusion
              fi

              # illusion <-> the-toy-factory
              echo "Configuring illusion <-> the-toy-factory..."
              if path_exists illusion the-toy-factory direct; then
                echo "  [OK] path 'direct' already exists"
              else
                echo "  [CREATE] path 'direct' via storage-toyfactory <-> storage-illusion"
                linstor_exec node-connection path create illusion the-toy-factory direct storage-toyfactory storage-illusion
              fi

              # the-dome <-> the-toy-factory
              echo "Configuring the-dome <-> the-toy-factory..."
              if path_exists the-dome the-toy-factory direct; then
                echo "  [OK] path 'direct' already exists"
              else
                echo "  [CREATE] path 'direct' via storage-toyfactory <-> storage-dome"
                linstor_exec node-connection path create the-dome the-toy-factory direct storage-toyfactory storage-dome
              fi

              echo ""
              echo "=== Step 3: Configuring DRBD Options for 25Gbps ==="
              linstor_exec controller drbd-options \
                --c-max-rate 2048000 \
                --c-min-rate 696320 \
                --resync-rate 696320 \
                --c-plan-ahead 20 \
                --c-fill-target 20480 \
                --max-buffers 65536 \
                --sndbuf-size 33554432 \
                --rcvbuf-size 33554432 || echo "  [WARN] Some DRBD options may not be supported"
              echo "  [OK] DRBD options configured"

              echo ""
              echo "=== Verification ==="
              echo "Node Interfaces:"
              linstor_exec node interface list illusion
              linstor_exec node interface list the-dome
              linstor_exec node interface list the-toy-factory

              echo ""
              echo "========================================"
              echo "Storage Network Configuration Complete!"
              echo "========================================"
