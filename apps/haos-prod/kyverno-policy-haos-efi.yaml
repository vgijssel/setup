apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: haos-vm-efi-boot
  annotations:
    policies.kyverno.io/title: Inject EFI bootloader and HAOS preference for HAOS VM
    policies.kyverno.io/category: KubeVirt
    policies.kyverno.io/description: >-
      Replaces the instanceProfile preference with 'haos' VirtualMachineClusterPreference
      and injects EFI bootloader with secure boot disabled. Required because Cozystack's
      Helm chart schema doesn't support custom instanceProfiles - we use 'ubuntu' as a
      placeholder in VMInstance and this policy replaces it with 'haos' at admission time.
spec:
  rules:
    - name: inject-efi-bootloader
      match:
        any:
          - resources:
              kinds:
                - kubevirt.io/v1/VirtualMachine
              names:
                - vm-instance-haos
              namespaces:
                - tenant-root
      mutate:
        patchStrategicMerge:
          spec:
            preference:
              kind: VirtualMachineClusterPreference
              name: haos
            template:
              spec:
                domain:
                  firmware:
                    bootloader:
                      efi:
                        secureBoot: false
