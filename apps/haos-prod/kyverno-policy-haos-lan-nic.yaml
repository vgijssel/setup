apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: haos-vm-lan-nic
  annotations:
    policies.kyverno.io/title: Add LAN NIC to HAOS VM
    policies.kyverno.io/category: KubeVirt
    policies.kyverno.io/description: >-
      Injects a third network interface into the HAOS VirtualMachine
      for direct Layer 2 connectivity to the 192.168.1.0/24 admin LAN.
      This enables Home Assistant to obtain an IP via DHCP from the
      physical LAN router for management and general network access.
spec:
  rules:
    - name: inject-lan-interface
      match:
        any:
          - resources:
              kinds:
                - kubevirt.io/v1/VirtualMachine
              names:
                - vm-instance-haos
              namespaces:
                - tenant-root
      preconditions:
        all:
          # Only apply if 'lan' network doesn't already exist
          - key: "lan"
            operator: AnyNotIn
            value: "{{ request.object.spec.template.spec.networks[].name || `[]` }}"
      mutate:
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/domain/devices/interfaces/-
            value:
              name: lan
              bridge: {}
          - op: add
            path: /spec/template/spec/networks/-
            value:
              name: lan
              multus:
                networkName: tenant-root/haos-lan
