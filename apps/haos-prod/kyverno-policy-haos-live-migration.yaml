apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: haos-vm-live-migration
  annotations:
    policies.kyverno.io/title: Enable Live Migration for HAOS VM
    policies.kyverno.io/category: KubeVirt
    policies.kyverno.io/description: >-
      Configures the HAOS VirtualMachine to support live migration with bridge
      networking by adding the allow-pod-bridge-network-live-migration annotation
      and setting evictionStrategy to LiveMigrate. This enables zero-downtime
      migration of the VM between cluster nodes while maintaining network connectivity.
spec:
  rules:
    - name: enable-live-migration
      match:
        any:
          - resources:
              kinds:
                - kubevirt.io/v1/VirtualMachine
              names:
                - vm-instance-haos
              namespaces:
                - tenant-root
      mutate:
        patchStrategicMerge:
          spec:
            template:
              metadata:
                annotations:
                  kubevirt.io/allow-pod-bridge-network-live-migration: "true"
              spec:
                evictionStrategy: LiveMigrate
