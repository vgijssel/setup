machine:
  type: controlplane
  certSANs:
    - 127.0.0.1
  network:
    kubespan:
      enabled: true
      filters:
        endpoints:
          - 0.0.0.0/0 # Allow all IPv4
          - "!100.64.0.0/10" # Exclude Kubespan overlay range to force LAN direct connections
  kubelet:
    extraConfig:
      cpuManagerPolicy: static
      maxPods: 512
    nodeIP:
      validSubnets:
        - 192.168.50.0/24
  sysctls:
    net.ipv4.neigh.default.gc_thresh1: "4096"
    net.ipv4.neigh.default.gc_thresh2: "8192"
    net.ipv4.neigh.default.gc_thresh3: "16384"
    net.core.rmem_max: "134217728"
    net.core.wmem_max: "134217728"
    net.core.netdev_max_backlog: "5000"
  kernel:
    modules:
      - name: openvswitch
      - name: drbd
        parameters:
          - usermode_helper=disabled
      - name: zfs
      - name: spl
      - name: vfio_pci
      - name: vfio_iommu_type1
  install:
    image: ghcr.io/cozystack/cozystack/talos:v1.11.3
  registries:
    mirrors:
      docker.io:
        endpoints:
          - https://mirror.gcr.io
  files:
    - content: |
        [plugins]
          [plugins."io.containerd.grpc.v1.cri"]
            device_ownership_from_security_context = true
          [plugins."io.containerd.cri.v1.runtime"]
            device_ownership_from_security_context = true
      permissions: 0
      path: /etc/cri/conf.d/20-customization.part
      op: create

cluster:
  clusterName: enigma-cozy
  controlPlane:
    endpoint: https://192.168.50.50:6443
  network:
    cni:
      name: none
    # Keep dnsDomain to cozy.local to prevent issues with Cozystack components
    dnsDomain: cozy.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/16
  allowSchedulingOnControlPlanes: true
  apiServer:
    extraArgs:
      oidc-issuer-url: https://keycloak.enigma.vgijssel.nl/realms/cozy
      oidc-client-id: kubernetes
      oidc-username-claim: preferred_username
      oidc-groups-claim: groups
    certSANs:
      - 127.0.0.1
      - api.enigma.vgijssel.nl
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0
  scheduler:
    extraArgs:
      bind-address: 0.0.0.0
  proxy:
    disabled: true
  discovery:
    enabled: true
  etcd:
    advertisedSubnets:
      - 192.168.50.0/24
