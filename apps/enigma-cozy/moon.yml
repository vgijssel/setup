fileGroups:
  default:
    - glob: "**/*"
      cache: true
language: javascript
layer: application
dependsOn:
  - talos-image
project:
  description: Cozystack configuration for Enigma cluster
  metadata:
    dependencies:
      cozystack/cozystack:
        version: v0.41.2
        datasource: github-releases
tags:
  - scope.app
  - type.stack
  - kubernetes
  - development
tasks:
  reset:
    script: |
      talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.42 -e 192.168.1.42 --reboot --graceful=false --wait=false
      talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.41 -e 192.168.1.41 --reboot --graceful=false --wait=false
      talosctl reset --system-labels-to-wipe STATE --system-labels-to-wipe EPHEMERAL -n 192.168.1.40 -e 192.168.1.40 --reboot --graceful=false --wait=false
    options:
      runInCI: false
      interactive: true
  generate-bootstrap:
    script: |
      mkdir -p /secrets/enigma-cozy/dist
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @illusion.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/illusion.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @the-dome.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/the-dome.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @the-toy-factory.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/the-toy-factory.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @here-i-am.patch.yaml --output-types worker -o /secrets/enigma-cozy/dist/here-i-am.yaml enigma-cozy https://192.168.50.50:6443 --force
      # Remove exclude-from-external-load-balancers label from controlplane nodes
      # This label is added by Talos defaults after patches are applied, so we must patch post-generation
      # See: https://github.com/siderolabs/talos/issues/9325
      for node in illusion the-dome the-toy-factory; do
        talosctl machineconfig patch /secrets/enigma-cozy/dist/${node}.yaml --patch @controlplane-post.patch.yaml -o /secrets/enigma-cozy/dist/${node}.yaml
      done
    options:
      runInCI: false
  apply-bootstrap:
    script: |
      talosctl apply-config --insecure -n 192.168.1.42 -e 192.168.1.42 --file /secrets/enigma-cozy/dist/illusion.yaml
      talosctl apply-config --insecure -n 192.168.1.41 -e 192.168.1.41 --file /secrets/enigma-cozy/dist/the-dome.yaml
      talosctl apply-config --insecure -n 192.168.1.40 -e 192.168.1.40 --file /secrets/enigma-cozy/dist/the-toy-factory.yaml
      talosctl apply-config --insecure -n 46.224.93.115 -e 46.224.93.115 --file /secrets/enigma-cozy/dist/here-i-am.yaml
      wait-for-it --service 192.168.50.10:50000
      wait-for-it --service 192.168.50.11:50000
      wait-for-it --service 192.168.50.12:50000
      wait-for-it --service 46.224.93.115:50000
      talosctl bootstrap -n 192.168.50.10 -e 192.168.50.10
      talosctl kubeconfig --force -n 192.168.50.50 kubeconfig.admin
    deps:
      - generate-bootstrap
    options:
      runInCI: false
      interactive: true
  generate:
    script: |
      mkdir -p /secrets/enigma-cozy/dist
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @illusion.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/illusion.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @the-dome.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/the-dome.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @the-toy-factory.patch.yaml --output-types controlplane -o /secrets/enigma-cozy/dist/the-toy-factory.yaml enigma-cozy https://192.168.50.50:6443 --force
      talosctl gen config --with-secrets /secrets/enigma-cozy/secrets.yaml --config-patch @all.patch.yaml --config-patch @here-i-am.patch.yaml --output-types worker -o /secrets/enigma-cozy/dist/here-i-am.yaml enigma-cozy https://192.168.50.50:6443 --force
      # Remove exclude-from-external-load-balancers label from controlplane nodes
      # This label is added by Talos defaults after patches are applied, so we must patch post-generation
      # See: https://github.com/siderolabs/talos/issues/9325
      for node in illusion the-dome the-toy-factory; do
        talosctl machineconfig patch /secrets/enigma-cozy/dist/${node}.yaml --patch @controlplane-post.patch.yaml -o /secrets/enigma-cozy/dist/${node}.yaml
      done
    options:
      runInCI: false
  apply:
    script: |
      talosctl apply-config -n 192.168.50.10 -e 192.168.50.10 --file /secrets/enigma-cozy/dist/illusion.yaml
      talosctl apply-config -n 192.168.50.11 -e 192.168.50.11 --file /secrets/enigma-cozy/dist/the-dome.yaml
      talosctl apply-config -n 192.168.50.12 -e 192.168.50.12 --file /secrets/enigma-cozy/dist/the-toy-factory.yaml
      talosctl apply-config -n 46.224.93.115 -e 46.224.93.115 --file /secrets/enigma-cozy/dist/here-i-am.yaml
    deps:
      - generate
    options:
      runInCI: false
      interactive: true
  reboot:
    command: talosctl reboot -n 192.168.50.10,192.168.50.11,192.168.50.12
    options:
      runInCI: false
      interactive: true
  upgrade-cozy:
    command: ./scripts/upgrade-cozy.sh
    options:
      runInCI: false
      interactive: true
  upgrade-talos:
    command: ./scripts/upgrade-talos.sh
    options:
      runInCI: false
      interactive: true
  validate:
    command: goss validate
    options:
      runInCI: false
  snapshot-etcd:
    command: ./scripts/snapshot-etcd.sh
    options:
      runInCI: false
