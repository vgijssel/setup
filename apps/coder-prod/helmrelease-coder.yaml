apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coder
  namespace: flux-system
spec:
  interval: 30m
  chart:
    spec:
      chart: third_party/vendir/charts/coder
      sourceRef:
        kind: GitRepository
        name: setup
        namespace: flux-system
      interval: 12h
  targetNamespace: coder
  dependsOn:
    - name: 1password-secrets
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    coder:
      serviceAccount:
        workspacePerms: true
        enableDeployments: true
        workspaceNamespaces:
          - name: coder-workspace
            workspacePerms: true
            enableDeployments: true
      env:
        # PostgreSQL connection components from 1Password
        - name: PG_USER
          valueFrom:
            secretKeyRef:
              name: coder-db-credentials
              key: username
        - name: PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: coder-db-credentials
              key: credential
        - name: PG_HOST
          valueFrom:
            secretKeyRef:
              name: coder-db-credentials
              key: hostname
        - name: PG_DATABASE
          valueFrom:
            secretKeyRef:
              name: coder-db-credentials
              key: database
        # Build PostgreSQL connection URL from components
        - name: CODER_PG_CONNECTION_URL
          value: postgres://$(PG_USER):$(PG_PASSWORD)@$(PG_HOST):5432/$(PG_DATABASE)?sslmode=require
        # Access URLs for Tailscale ingress
        - name: CODER_ACCESS_URL
          value: https://coder.enigma.vgijssel.nl
        - name: CODER_WILDCARD_ACCESS_URL
          value: "*.coder.enigma.vgijssel.nl"
        # OIDC authentication with Keycloak
        - name: CODER_OIDC_ISSUER_URL
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc
              key: issuer_url
        - name: CODER_OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc
              key: client_id
        - name: CODER_OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc
              key: client_secret
        - name: CODER_OIDC_USERNAME_FIELD
          value: preferred_username
        - name: CODER_OIDC_SCOPES
          value: openid profile email offline_access
        - name: CODER_DISABLE_PASSWORD_AUTH
          value: "true"
        # GitHub OAuth configuration
        - name: CODER_OAUTH2_GITHUB_ALLOW_SIGNUPS
          value: "false"
        - name: CODER_OAUTH2_GITHUB_ALLOWED_ORGS
          value: vgijssel
        # GitHub external authentication
        - name: CODER_EXTERNAL_AUTH_0_ID
          value: primary-github
        - name: CODER_EXTERNAL_AUTH_0_TYPE
          value: github
        - name: CODER_EXTERNAL_AUTH_0_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: github-coder-prod-external-authentication
              key: username
        - name: CODER_EXTERNAL_AUTH_0_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: github-coder-prod-external-authentication
              key: credential
        # 1Password Connect configuration for Terraform provider
        - name: OP_CONNECT_HOST
          value: http://onepassword-connect.1password.svc.cluster.local:8080
        - name: OP_CONNECT_TOKEN
          valueFrom:
            secretKeyRef:
              name: onepassword-connect-token-setup-devenv
              key: credential
      # Use ClusterIP since we expose via Tailscale Ingress
      service:
        type: ClusterIP
      # Enable built-in ingress
      ingress:
        enable: true
        className: nginx
        host: coder.enigma.vgijssel.nl
        wildcardHost: "*.coder.enigma.vgijssel.nl"
        tls:
          enable: false
      # Resource constraints
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
