language: javascript
layer: application
dependsOn:
  - registry
tags:
  - stack
  - kubernetes
  - production
  - stack
  - kubernetes
  - production
tasks:
  create-1password-secret:
    command: $MOON_WORKSPACE_ROOT/libs/1password-operator-bootstrap/bootstrap.sh --credentials-ref "$CREDENTIALS_REF" --token-ref "$TOKEN_REF"
    env:
      CREDENTIALS_REF: op://setup-coder-prod/coder-prod Credentials File/1password-credentials.json
      TOKEN_REF: op://setup-coder-prod/kzsqg7xbgiz7jbvxksugadymne/credential
    options:
      runInCI: false

  bootstrap:
    command: kubectl apply -k $MOON_WORKSPACE_ROOT/apps/coder-prod/
    deps:
      - create-1password-secret
    options:
      runInCI: false
