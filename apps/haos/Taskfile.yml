version: "3"

tasks:
  apply:
    desc: Apply the Ansible playbook
    dir: ansible
    cmds:
      - ansible-playbook -i hosts provision.yml

  sync:
    desc: Sync files between local and remote environment
    cmds:
      - unison haos {{.CLI_ARGS}}

  update:
    desc: Check config and reload Home Assistant if valid
    cmds:
      - echo "Checking Home Assistant configuration..."
      - |
        curl -sf \
           -H "Authorization: Bearer $HA_TOKEN" \
           -H "Content-Type: application/json" \
           -X POST \
           http://192.168.1.32:8123/api/config/core/check_config 
         echo ""
      - echo "Configuration is valid. Reloading Home Assistant..."
      - |
        curl -sf \
            -H "Authorization: Bearer $HA_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            -d '{}' \
            http://192.168.1.32:8123/api/services/homeassistant/reload_all
          echo ""
      - echo "Home Assistant reload completed."
