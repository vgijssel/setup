blueprint:
  name: Room Occupancy
  description: Automation to track room occupancy based on door presence sensors and occupancy presence sensor
  domain: automation
  input:
    door_sensors:
      name: Door Presence Sensors
      description: List of door presence sensor entities for the room
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    occupancy_sensor:
      name: Occupancy Presence Sensor
      description: The occupancy presence sensor entity
      selector:
        entity:
          domain: binary_sensor
    occupancy_state_selector:
      name: Occupancy State Selector
      description: The input_select entity that tracks occupancy state
      selector:
        entity:
          domain: input_select
    occupancy_timer:
      name: Occupancy Timer
      description: The timer entity used for occupancy state transitions
      selector:
        entity:
          domain: timer
    occupancy_toggle:
      name: Occupancy Toggle
      description: The input_boolean entity that indicates if the room is occupied
      selector:
        entity:
          domain: input_boolean
    entering_timer_duration:
      name: Entering Timer Duration
      description: Duration for entering state transition
      default: 10
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds
    entering_confirm_timer_duration:
      name: Entering Confirm Timer Duration
      description: Duration for entering_confirm state transition
      default: 10
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds
    leaving_timer_duration:
      name: Leaving Timer Duration
      description: Duration for leaving state transition
      default: 10
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds
    leaving_confirm_timer_duration:
      name: Leaving Confirm Timer Duration
      description: Duration for leaving_confirm state transition
      default: 10
      selector:
        number:
          min: 1
          max: 3600
          unit_of_measurement: seconds

variables:
  door_sensors: !input door_sensors
  occupancy_sensor: !input occupancy_sensor
  occupancy_state_selector: !input occupancy_state_selector
  occupancy_timer: !input occupancy_timer
  occupancy_toggle: !input occupancy_toggle
  entering_timer_duration: !input entering_timer_duration
  entering_confirm_timer_duration: !input entering_confirm_timer_duration
  leaving_timer_duration: !input leaving_timer_duration
  leaving_confirm_timer_duration: !input leaving_confirm_timer_duration
  doors_have_activity: "{{ expand(door_sensors) | selectattr('state', 'eq', 'on') | list | count > 0 }}"
  occupancy_has_activity: "{{ occupancy_sensor.state == 'on' }}"
  timer_duration: >
    {% set state = states(occupancy_state_selector) %}
    {% if state == 'entering' %}
      {{ '00:00:' + (entering_timer_duration | string).zfill(2) }}
    {% elif state == 'entering_confirm' %}
      {{ '00:00:' + (entering_confirm_timer_duration | string).zfill(2) }}
    {% elif state == 'leaving' %}
      {{ '00:00:' + (leaving_timer_duration | string).zfill(2) }}
    {% elif state == 'leaving_confirm' %}
      {{ '00:00:' + (leaving_confirm_timer_duration | string).zfill(2) }}
    {% else %}
      {{ '00:00:' + (entering_timer_duration | string).zfill(2) }}
    {% endif %}

trigger:
  - trigger: state
    entity_id: !input door_sensors
    from:
    to:
    id: door
  - trigger: state
    entity_id: !input occupancy_state_selector
    id: select
  - trigger: state
    entity_id: !input occupancy_timer
    from:
    to:
    id: timer
  - trigger: state
    entity_id: !input occupancy_sensor
    id: occupancy
  - trigger: state
    entity_id: !input occupancy_toggle
    from:
    to:
    id: toggle

condition: []

action:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - select
        sequence:
          - if:
              - condition: state
                entity_id: !input occupancy_state_selector
                state:
                  - entering
                  - entering_confirm
                  - leaving
                  - leaving_confirm
            then:
              - action: timer.start
                metadata: {}
                data:
                  duration: "{{ timer_duration }}"
                target:
                  entity_id: !input occupancy_timer
          - if:
              - condition: state
                entity_id: !input occupancy_state_selector
                state:
                  - entering
                  - entering_confirm
                  - present
                  - leaving
                  - leaving_confirm
            then:
              - action: input_boolean.turn_on
                metadata: {}
                target:
                  entity_id: !input occupancy_toggle
            else:
              - action: input_boolean.turn_off
                metadata: {}
                target:
                  entity_id: !input occupancy_toggle
      - conditions:
          - condition: trigger
            id:
              - toggle
        sequence:
          - if:
              - condition: state
                entity_id: !input occupancy_toggle
                state: "on"
            then:
              - action: input_select.select_option
                metadata: {}
                data:
                  option: present
                target:
                  entity_id: !input occupancy_state_selector
            else:
              - action: input_select.select_option
                metadata: {}
                data:
                  option: absent
                target:
                  entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: absent
        sequence:
          - if:
              - condition: template
                value_template: "{{ doors_have_activity }}"
            then:
              - action: input_select.select_option
                metadata: {}
                data:
                  option: entering
                target:
                  entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: entering
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_sensor
                    state: "on"
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: entering_confirm
                    target:
                      entity_id: !input occupancy_state_selector
              - conditions:
                  - condition: template
                    value_template: "{{ doors_have_activity }}"
                sequence:
                  - if:
                      - condition: not
                        conditions:
                          - condition: state
                            entity_id: !input occupancy_timer
                            state: paused
                    then:
                      - action: timer.start
                        metadata: {}
                        data:
                          duration: "{{ timer_duration }}"
                        target:
                          entity_id: !input occupancy_timer
                      - action: timer.pause
                        metadata: {}
                        data: {}
                        target:
                          entity_id: !input occupancy_timer
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: paused
                sequence:
                  - action: timer.start
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input occupancy_timer
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: idle
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: absent
                    target:
                      entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: entering_confirm
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_sensor
                    state: "off"
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: entering
                    target:
                      entity_id: !input occupancy_state_selector
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: idle
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: present
                    target:
                      entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: present
        sequence:
          - if:
              - condition: template
                value_template: "{{ doors_have_activity }}"
            then:
              - action: input_select.select_option
                metadata: {}
                data:
                  option: leaving
                target:
                  entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: leaving
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_sensor
                    state: "off"
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: leaving_confirm
                    target:
                      entity_id: !input occupancy_state_selector
              - conditions:
                  - condition: template
                    value_template: "{{ doors_have_activity }}"
                sequence:
                  - if:
                      - condition: not
                        conditions:
                          - condition: state
                            entity_id: !input occupancy_timer
                            state: paused
                    then:
                      - action: timer.start
                        metadata: {}
                        data:
                          duration: "{{ timer_duration }}"
                        target:
                          entity_id: !input occupancy_timer
                      - action: timer.pause
                        metadata: {}
                        data: {}
                        target:
                          entity_id: !input occupancy_timer
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: paused
                sequence:
                  - action: timer.start
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input occupancy_timer
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: idle
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: present
                    target:
                      entity_id: !input occupancy_state_selector
      - conditions:
          - condition: state
            entity_id: !input occupancy_state_selector
            state: leaving_confirm
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_sensor
                    state: "on"
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: leaving
                    target:
                      entity_id: !input occupancy_state_selector
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_timer
                    state: idle
                sequence:
                  - action: input_select.select_option
                    metadata: {}
                    data:
                      option: absent
                    target:
                      entity_id: !input occupancy_state_selector

mode: queued
max: 25
max_exceeded: silent
trace:
  stored_traces: 500
