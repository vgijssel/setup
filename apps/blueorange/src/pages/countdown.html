<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Orange - Countdown</title>
  <link rel="stylesheet" href="../styles/countdown.css">
</head>
<body>
  <div class="container">
    <h1 class="top-text">
      SHE WILL MAKE <span class="highlight">Him</span> SORRY
    </h1>

    <div class="timer-container">
      <div class="timer-unit">
        <div class="timer-digit" id="days">00</div>
        <div class="timer-label">DAYS</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="hours">00</div>
        <div class="timer-label">HOURS</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="minutes">00</div>
        <div class="timer-label">MINUTES</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="seconds">00</div>
        <div class="timer-label">SECONDS</div>
      </div>
    </div>

    <h2 class="bottom-text">KLAASSANDRA</h2>
  </div>

  <script type="module">
    import { SessionManager } from '../scripts/session-manager.js';
    import { Timer } from '../scripts/timer.js';
    import { CRTFilterWebGL } from '../scripts/CRTFilter.js';
    import html2canvas from 'html2canvas';

    const sessionManager = new SessionManager();

    // Check authorization
    if (!sessionManager.isValidated()) {
      window.location.href = '/src/pages/landing.html';
    }

    // Initialize timer
    const targetDate = '2025-11-20T00:00:00+01:00'; // Europe/Amsterdam (CET)
    const timer = new Timer(targetDate);

    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');

    function updateDisplay(time) {
      daysEl.textContent = String(time.days).padStart(2, '0');
      hoursEl.textContent = String(time.hours).padStart(2, '0');
      minutesEl.textContent = String(time.minutes).padStart(2, '0');
      secondsEl.textContent = String(time.seconds).padStart(2, '0');
    }

    timer.start(updateDisplay);

    // Initialize CRT Filter for full-screen effect
    const canvas = document.getElementById('crt-canvas');
    const container = document.querySelector('.container');
    let crtEffect = null;
    let updateIntervalId = null;

    // Set canvas size to match window size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Function to update canvas content
    async function updateCanvasContent() {
      try {
        if (!container || container.style.display === 'none') return;

        // Capture the page content
        const pageCanvas = await html2canvas(container, {
          backgroundColor: null,
          scale: 1,
          logging: false,
          useCORS: true
        });

        // Copy the captured content to our canvas
        const ctx = canvas.getContext('2d');

        // Fill background first
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0a3a3a');
        gradient.addColorStop(0.25, '#1a4a4a');
        gradient.addColorStop(0.5, '#8b4513');
        gradient.addColorStop(0.75, '#d2691e');
        gradient.addColorStop(1, '#0a3a3a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Center and draw the captured content
        const x = (canvas.width - pageCanvas.width) / 2;
        const y = (canvas.height - pageCanvas.height) / 2;
        ctx.drawImage(pageCanvas, x, y);
      } catch (error) {
        console.error('Error updating canvas:', error);
      }
    }

    // Function to start CRT effect
    async function startCRTEffect() {
      // Update canvas content continuously before starting CRT
      await updateCanvasContent();

      // Set up interval to update content
      updateIntervalId = setInterval(updateCanvasContent, 1000);

      // Wait a bit for initial render, then start CRT effect
      setTimeout(() => {
        if (!crtEffect) {
          crtEffect = new CRTFilterWebGL(canvas, {
            barrelDistortion: 0.08,
            chromaticAberration: 0.8,
            staticNoise: 0.05,
            brightness: 1.0,
            contrast: 1.1,
            curvature: 0.15,
            scanlineIntensity: 0.3,
            glowBloom: 0.002,
            verticalJitter: 0.002,
            horizontalTearing: 0.0002
          });
          crtEffect.start();

          // Hide the original content after CRT starts
          container.style.visibility = 'hidden';
        }
      }, 100);
    }

    // Start CRT effect after page loads
    setTimeout(startCRTEffect, 100);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      timer.stop();
      if (updateIntervalId) {
        clearInterval(updateIntervalId);
      }
      if (crtEffect) {
        crtEffect.stop();
      }
    });
  </script>
</body>
</html>
