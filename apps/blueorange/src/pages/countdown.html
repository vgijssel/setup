<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Orange - Countdown</title>
  <link rel="stylesheet" href="../styles/countdown.css">
</head>
<body>
  <div class="container" id="content-container">
    <h1 class="top-text">
      SHE WILL MAKE <span class="highlight">Him</span> SORRY
    </h1>

    <div class="timer-container">
      <div class="timer-unit">
        <div class="timer-digit" id="days">00</div>
        <div class="timer-label">DAYS</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="hours">00</div>
        <div class="timer-label">HOURS</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="minutes">00</div>
        <div class="timer-label">MINUTES</div>
      </div>
      <div class="timer-unit">
        <div class="timer-digit" id="seconds">00</div>
        <div class="timer-label">SECONDS</div>
      </div>
    </div>

    <h2 class="bottom-text">KLAASSANDRA</h2>
  </div>
  <canvas id="crt-canvas" class="crt-canvas-layer"></canvas>

  <script type="module">
    import { SessionManager } from '../scripts/session-manager.js';
    import { Timer } from '../scripts/timer.js';
    import { CRTFilterWebGL } from '../scripts/CRTFilter.js';
    import html2canvas from 'html2canvas';

    const sessionManager = new SessionManager();

    // Check authorization
    if (!sessionManager.isValidated()) {
      window.location.href = '/src/pages/landing.html';
    }

    // Initialize timer
    const targetDate = '2025-11-20T00:00:00+01:00'; // Europe/Amsterdam (CET)
    const timer = new Timer(targetDate);

    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');

    function updateDisplay(time) {
      daysEl.textContent = String(time.days).padStart(2, '0');
      hoursEl.textContent = String(time.hours).padStart(2, '0');
      minutesEl.textContent = String(time.minutes).padStart(2, '0');
      secondsEl.textContent = String(time.seconds).padStart(2, '0');
    }

    timer.start(updateDisplay);

    // Initialize CRT Filter for full-screen effect
    const canvas = document.getElementById('crt-canvas');
    const container = document.getElementById('content-container');
    let crtEffect = null;
    let updateIntervalId = null;

    // Set canvas size to match window size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    resizeCanvas();
    window.addEventListener('resize', () => {
      resizeCanvas();
      // Force a canvas update after resize
      updateCanvasContent();
    });

    // Function to render HTML content to canvas
    async function updateCanvasContent() {
      try {
        // Get the 2D context and draw to our main canvas
        const ctx = canvas.getContext('2d', { alpha: false });

        // Draw background gradient first (makes canvas opaque)
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0a3a3a');
        gradient.addColorStop(0.25, '#1a4a4a');
        gradient.addColorStop(0.5, '#8b4513');
        gradient.addColorStop(0.75, '#d2691e');
        gradient.addColorStop(1, '#0a3a3a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Capture the HTML content as a canvas
        const htmlCanvas = await html2canvas(container, {
          backgroundColor: null,
          scale: 1,
          logging: false,
          useCORS: true,
          windowWidth: canvas.width,
          windowHeight: canvas.height,
          width: canvas.width,
          height: canvas.height,
          x: 0,
          y: 0
        });

        // Draw the captured content (it should already match canvas size)
        ctx.drawImage(htmlCanvas, 0, 0);
      } catch (error) {
        console.error('Error rendering HTML to canvas:', error);
      }
    }

    // Function to start CRT effect
    async function startCRTEffect() {
      // Initial render
      await updateCanvasContent();

      // Update canvas content every second (for timer updates)
      updateIntervalId = setInterval(updateCanvasContent, 1000);

      // Start CRT effect after initial render
      setTimeout(() => {
        if (!crtEffect) {
          crtEffect = new CRTFilterWebGL(canvas, {
            barrelDistortion: 0.08,
            chromaticAberration: 0.8,
            staticNoise: 0.05,
            brightness: 1.0,
            contrast: 1.1,
            curvature: 0.15,
            scanlineIntensity: 0.3,
            glowBloom: 0.002,
            verticalJitter: 0.002,
            horizontalTearing: 0.0002
          });
          crtEffect.start();
        }
      }, 100);
    }

    // Start CRT effect after page loads
    setTimeout(startCRTEffect, 100);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      timer.stop();
      if (updateIntervalId) {
        clearInterval(updateIntervalId);
      }
      if (crtEffect) {
        crtEffect.stop();
      }
    });
  </script>
</body>
</html>
