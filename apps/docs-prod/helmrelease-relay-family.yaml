apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: relay-family
  namespace: cozy-fluxcd
spec:
  interval: 30m
  driftDetection:
    mode: enabled
  chart:
    spec:
      chart: libs/relay-server
      sourceRef:
        kind: GitRepository
        name: setup
        namespace: cozy-fluxcd
      interval: 12h
  targetNamespace: relay
  dependsOn:
    - name: 1password-secrets
  install:
    createNamespace: true
    replace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    name: relay-family
    replicaCount: 1
    image:
      repository: docker.system3.md/relay-server
      tag: v0.9.2
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 40m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    ulimits:
      nofile:
        soft: 1024
        hard: 1024
    livenessProbe:
      tcpSocket:
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      tcpSocket:
        port: http
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    service:
      type: LoadBalancer
      port: 80
      targetPort: 8080
    env:
      relayServerUrl: https://family.relay.enigma.vgijssel.nl
      relayServerStorage: s3
      awsRegion: us-east-1
      awsEndpointUrlS3: https://s3.enigma.vgijssel.nl
      awsBucket: bucket-7f79c3ba-4dd7-42f1-9844-1e17302da678
      awsS3UsePathStyle: "true"
    # Reference the 1Password-managed secret
    # Note: 1Password item has keys: accessKey, secretKey, bucket, endpoint
    secretReference:
      name: relay-family-s3-credentials
      keys:
        awsAccessKeyId: accessKey
        awsSecretAccessKey: secretKey
