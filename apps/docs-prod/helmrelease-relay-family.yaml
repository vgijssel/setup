apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: relay-family
  namespace: cozy-fluxcd
spec:
  interval: 30m
  driftDetection:
    mode: enabled
  chart:
    spec:
      chart: third_party/vendir/charts/relay-server
      sourceRef:
        kind: GitRepository
        name: setup
        namespace: cozy-fluxcd
      interval: 12h
  targetNamespace: relay
  dependsOn:
    - name: 1password-secrets
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  # Patch the service to use LoadBalancer type for KubeVirt CCM mirroring
  # and fix selector mismatch (chart bug: service uses fullname, deployment uses name)
  postRenderers:
    - kustomize:
        patches:
          # Rename deployment to avoid conflict with relay-personal
          - target:
              kind: Deployment
              name: relay-server
            patch: |
              - op: replace
                path: /metadata/name
                value: relay-family
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1name
                value: relay-family
              - op: replace
                path: /spec/selector/matchLabels/app.kubernetes.io~1name
                value: relay-family
              - op: replace
                path: /spec/template/metadata/labels/app.kubernetes.io~1name
                value: relay-family
          # Patch service to use LoadBalancer and correct selector
          # Note: FluxCD prefixes release name with targetNamespace, so full name is relay-relay-family-relay-server
          - target:
              kind: Service
              name: relay-relay-family-relay-server
            patch: |
              - op: add
                path: /spec/type
                value: LoadBalancer
              - op: replace
                path: /spec/selector
                value:
                  app.kubernetes.io/name: relay-family
  values:
    name: relay-server
    hostname: family.relay.enigma.vgijssel.nl
    replicaCount: 1
    image:
      repository: docker.system3.md/relay-server
      tag: v0.9.2
      pullPolicy: Always
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    port: 8080
    # Disable chart's built-in ingress - we use enigma-cluster ingress
    ingress:
      certManager:
        enabled: false
    env:
      relayServerUrl: https://family.relay.enigma.vgijssel.nl
      relayServerStorage: s3
      awsRegion: us-east-1
      awsEndpointUrlS3: https://s3.enigma.vgijssel.nl
      awsBucket: bucket-7f79c3ba-4dd7-42f1-9844-1e17302da678
      awsS3UsePathStyle: "true"
    # Reference the 1Password-managed secret
    # Note: 1Password item has keys: accessKey, secretKey, bucket, endpoint
    secretReference:
      name: relay-family-s3-credentials
      keys:
        awsAccessKeyId: accessKey
        awsSecretAccessKey: secretKey
