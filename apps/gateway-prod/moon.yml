language: javascript
layer: application
tags:
  - app
  - terraform
  - hetzner
  - infrastructure
  - app
  - terraform
  - hetzner
  - infrastructure
tasks:
  apply:
    command: set -a && source .env && set +a && tofu apply -auto-approve
    deps:
      - ~:init
    env:
      CWD: apps/gateway-prod
    local: true
  destroy:
    command: set -a && source .env && set +a && tofu destroy -auto-approve
    deps:
      - ~:init
    env:
      CWD: apps/gateway-prod
    local: true
  init:
    command: set -a && source .env && set +a && tofu init -backend-config="bucket=$TF_VAR_s3_bucket"
    deps:
      - ~:secrets
    env:
      CWD: apps/gateway-prod
    local: true
  output:
    command: set -a && source .env && set +a && tofu output
    deps:
      - ~:init
    env:
      CWD: apps/gateway-prod
    local: true
  plan:
    command: set -a && source .env && set +a && tofu plan
    deps:
      - ~:init
    env:
      CWD: apps/gateway-prod
    local: true
  secrets:
    command: op inject --force -i .env.tpl -o .env
    env:
      CWD: apps/gateway-prod
    inputs:
      - file: .env.tpl
    outputs:
      - .env
