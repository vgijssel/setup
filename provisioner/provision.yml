---
- name: "Provision Provisioner"
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Get docker swarm status
      tags: ["docker"]
      command: docker info --format {%raw%} '{{.Swarm.LocalNodeState}}' {%endraw%}
      register: swarm_status

    - name: Print swarm status
      debug:
        msg: "Swarm status: {{ swarm_status.stdout }}"

    - name: Init docker swarm
      tags: ["docker"]
      when: swarm_status.stdout != "active"
      command: "docker swarm init"

    - name: Wait for docker swarm to be active
      tags: ["docker"]
      retries: 60
      register: swarm_status
      delay: 5
      until: swarm_status.stdout == "active"
      command: docker info --format {%raw%} '{{.Swarm.LocalNodeState}}' {%endraw%}
